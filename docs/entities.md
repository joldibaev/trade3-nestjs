# Документация сущностей (Entities)

В этой документации описаны основные модели данных, используемые в системе учета товаров.

## Содержание

- [Базовые сущности](#базовые-сущности)
- [Товары и Цены](#товары-и-цены)
- [Склады и Остатки](#склады-и-остатки)
- [Документы](#документы)
- [Аудит движений и Пересчеты](#аудит-движений-и-пересчеты)

---

## Базовые сущности

### Store (Склад/Магазин)

Представляет физическую точку хранения или продажи.

- `id`: UUID (v7)
- `name`: Название (уникальное)
- `address`: Адрес (опционально)
- `isActive`: Флаг активности.
- `cashboxes`: Список привязанных касс.
- `stocks`: Остатки товаров на этом складе.

### Cashbox (Касса)

Денежная точка, привязанная к конкретному складу. Используется в документах продажи.

- `id`: UUID (v7)
- `name`: Название кассы.
- `storeId`: Ссылка на склад.
- `isActive`: Флаг активности.

### Vendor (Поставщик)

Юридическое или физическое лицо, у которого закупается товар.

- `id`: UUID (v7)
- `name`: Название поставщика.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.
- `isActive`: Флаг активности.

### Client (Клиент)

Покупатель товара. Используется в продажах и возвратах.

- `id`: UUID (v7)
- `name`: Имя/Название клиента.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.
- `isActive`: Флаг активности.

---

## Товары и Цены

### Product (Товар)

Основная единица учета.

- `id`: UUID (v7)
- `code`: Уникальный префиксный код (например, `P-10001`). Генерируется автоматически.
- `name`: Название товара.
- `article`: Артикул (необязательно).
- `categoryId`: Ссылка на категорию.
- `isActive`: Флаг активности товара (доступен ли для продажи).
- `barcodes`: Список штрих-кодов товара (`Barcode`).
- `prices`: Список актуальных цен разных типов.
- `stocks`: Состояние остатков на разных складах.
- `priceChangeItems`: История изменений цен этого товара (связь с `DocumentPriceChangeItem`).
- `inventoryReprocessingItems`: История затронутых пересчетов себестоимости.

### Barcode (Штрих-код)

- `value`: Значение штрих-кода (уникальное).
- `type`: Тип (EAN13, EAN8, CODE128, INTERNAL, OTHER).
- `productId`: Ссылка на товар.

### Category (Категория)

Группировка товаров для удобства поиска и отчетности. Поддерживает иерархию.

- `id`: UUID (v7)
- `name`: Название категории.
- `parentId`: Ссылка на родительскую категорию (опционально).
- `isActive`: Флаг активности.

### PriceType (Тип цены)

Определяет вид цены (например, "Розничная", "Оптовая").

- `id`: UUID (v7)
- `name`: Название типа цены.
- `isActive`: Флаг активности.

### Price (Актуальная цена)

Конкретное значение цены для товара.

- `id`: UUID (v7)
- `value`: Значение цены (Decimal(12, 2)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `updatedAt`: Дата последнего изменения.
  **Особенность**: Уникальный индекс по паре `productId` + `priceTypeId`. Гарантирует, что у товара может быть только одна текущая цена каждого типа.

### PriceLedger (Реестр цен)

Строго неизменяемый (append-only) реестр всех изменений цен. Предназначен для аудита и восстановления истории.

- `id`: UUID (v7)
- `valueBefore`: Снимок цены ДО изменения.
- `value`: Новое значение цены (Decimal(12, 2)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `documentPriceChangeId`: Ссылка на документ-основание (опционально).
- `date`: Дата "действия" цены (бизнес-время). 
- `createdAt`: Системное время записи.

---

## Склады и Остатки

### Stock (Остаток на складе)

Текущее состояние товара на конкретном складе.

- `productId`: Ссылка на товар.
- `storeId`: Ссылка на склад.
- `quantity`: Текущее количество (Decimal(12, 3)).
- `averagePurchasePrice`: Средневзвешенная цена закупки (WAP/Себестоимость) (Decimal(12, 2)).

---

## Документы

Все документы имеют статус (`DocumentStatus`): `DRAFT`, `COMPLETED`, `CANCELLED`, `SCHEDULED`. Остатки обновляются только при статусе `COMPLETED`. 

### DocumentPurchase (Закупка)

Оприходование товара от поставщика. Обновляет количество и пересчитывает WAP. 

- `code`: Номер документа с префиксом `P-`.
- `date`: Дата документа.
- `vendorId`: Ссылка на поставщика.
- `storeId`: Ссылка на склад.
- `total`: Общая сумма документа.
- `status`: Текущий статус.
- `generatedPriceChangeId`: Ссылка на автоматически созданный документ изменения цен (опционально).

### DocumentPurchaseItem (Позиция закупки)

- `purchaseId`: Ссылка на закупку.
- `productId`: Ссылка на товар.
- `quantity`: Количество (Decimal(12, 3)).
- `price`: Цена закупки (Decimal(12, 2)).
- `total`: Общая сумма по позиции.

### DocumentSale (Продажа)

Реализация товара клиенту. Уменьшает остатки, фиксирует цену продажи и себестоимость на момент продажи.

- `code`: Номер документа с префиксом `S-`.
- `storeId`: Ссылка на склад.
- `cashboxId`: Ссылка на кассу.
- `clientId`: Ссылка на клиента (необязательно).
- `priceTypeId`: Тип цены, по которой совершена продажа.
- `total`: Общая сумма.
- `status`: Текущий статус.

### DocumentSaleItem (Позиция продажи)

- `saleId`: Ссылка на продажу.
- `productId`: Ссылка на товар.
- `quantity`: Количество.
- `price`: Цена продажи.
- `costPrice`: Себестоимость (WAP) в момент продажи.
- `total`: Сумма.

### DocumentReturn (Возврат от клиента)

Возврат проданного товара. Увеличивает остатки. Не влияет на WAP (себестоимость).

- `code`: Номер документа с префиксом `R-`.
- `clientId`: Ссылка на клиента.
- `status`: Текущий статус.
- `items`: Список товаров (`DocumentReturnItem`).

### DocumentAdjustment (Инвентаризация/Корректировка)

Ручная корректировка остатков (излишки/недостачи).

- `code`: Номер документа с префиксом `A-`.
- `storeId`: Ссылка на склад.
- `status`: Текущий статус.
- `items`: Список товаров (`DocumentAdjustmentItem`). Включает снимки `quantityBefore` и `quantityAfter`.

### DocumentTransfer (Перемещение)

Перемещение товара между складами. Уменьшает остатки на складе-источнике и увеличивает на складе-получателе.

- `code`: Номер документа с префиксом `T-`.
- `sourceStoreId`: Откуда.
- `destinationStoreId`: Куда.
- `status`: Текущий статус.
- `items`: Список товаров.

### DocumentPriceChange (Изменение цен)

Документ для явного изменения розничных/оптовых цен.

- `code`: Номер документа с префиксом `PC-`.
- `date`: Дата вступления цен в силу.
- `status`: Текущий статус.
- `items`: Список товаров и новых цен (`DocumentPriceChangeItem`).

### DocumentPriceChangeItem (Позиция изменения цены)

Конкретное изменение цены для одного товара и типа цены в рамках документа.

- `documentId`: Ссылка на документ изменения цен.
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `oldValue`: Старое значение цены (Decimal).
- `newValue`: Новое значение цены (Decimal).

---

## Аудит движений и Пересчеты

### StockLedger (Реестр движения товаров)

Лог движения товаров. Неизменяемый (append-only) реестр всех изменений остатков.

- `type`: Тип операции (PURCHASE, SALE, RETURN, ADJUSTMENT, TRANSFER_IN, TRANSFER_OUT)
- `storeId`: Ссылка на магазин
- `productId`: Ссылка на товар
- `quantity`: Изменение количества (дельта).
- `quantityBefore`: Остаток ДО операции.
- `quantityAfter`: Остаток ПОСЛЕ операции.
- `averagePurchasePrice`: Себестоимость единицы (WAP) на момент операции.
- `transactionAmount`: Общая стоимость операции.
- `batchId`: Группировка движений в рамках одного документа.
- `date`: Дата операции (бизнес-время)

### DocumentLedger (Журнал изменений документов)

Системный лог всех действий с документами.

- `action`: Действие (CREATED, UPDATED, STATUS_CHANGED и т.д.)
- `details`: JSON-объект с деталями изменений.
- `document[Type]Id`: Ссылка на соответствующий документ.

### InventoryReprocessing (Пересчет истории)

Системный документ, фиксирующий факт и результат пересчета хронологической истории движений товара.

- `date`: Дата, с которой начат пересчет.
- `status`: Состояние (`PENDING`, `COMPLETED`, `FAILED`).
- `document[Type]Id`: Ссылка на документ-первоисточник, вызвавший пересчет.
- `items`: Детализация пересчета (`InventoryReprocessingItem`).

### InventoryReprocessingItem (Результат пересчета)

Конкретный результат пересчета для пары Товар-Склад.

- `productId`: Ссылка на товар.
- `storeId`: Ссылка на склад.
- `oldAveragePurchasePrice` / `newAveragePurchasePrice`: Себестоимость ДО и ПОСЛЕ.
- `oldQuantity` / `newQuantity`: Остаток ДО и ПОСЛЕ.
- `affectedLedgerCount`: Количество обновленных записей в `StockLedger`.
