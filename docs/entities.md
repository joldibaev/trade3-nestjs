# Документация сущностей (Entities)

В этой документации описаны основные модели данных, используемые в системе учета товаров.

## Содержание

- [Базовые сущности](#базовые-сущности)
- [Товары и Цены](#товары-и-цены)
- [Склады и Остатки](#склады-и-остатки)
- [Документы](#документы)
- [Аудит движений и Пересчеты](#аудит-движений-и-пересчеты)

---

## Базовые сущности

### Store (Склад/Магазин)

Представляет физическую точку хранения или продажи.

- `id`: UUID (v7)
- `name`: Название (уникальное)
- `address`: Адрес (опционально)
- `cashboxes`: Список привязанных касс.
- `stocks`: Остатки товаров на этом складе.

### Cashbox (Касса)

Денежная точка, привязанная к конкретному складу. Используется в документах продажи.

- `id`: UUID (v7)
- `name`: Название кассы.
- `storeId`: Ссылка на склад.

### Vendor (Поставщик)

Юридическое или физическое лицо, у которого закупается товар.

- `id`: UUID (v7)
- `name`: Название поставщика.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

### Client (Клиент)

Покупатель товара. Используется в продажах и возвратах.

- `id`: UUID (v7)
- `name`: Имя/Название клиента.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

---

## Товары и Цены

### Product (Товар)

Основная единица учета.

- `id`: UUID (v7)
- `code`: Уникальный префиксный код (например, `P-10001`). Генерируется автоматически.
- `name`: Название товара.
- `article`: Артикул (необязательно).
- `categoryId`: Ссылка на категорию.
- `isActive`: Флаг активности товара (доступен ли для продажи).
- `barcodes`: Список штрих-кодов товара (`Barcode`).
- `prices`: Список актуальных цен разных типов.
- `stocks`: Состояние остатков на разных складах.
- `revaluationItems`: История изменений цен этого товара (связь с `DocumentRevaluationItem`).
- `inventoryReprocessingItems`: История затронутых пересчетов себестоимости.

### Barcode (Штрих-код)

- `value`: Значение штрих-кода (уникальное).
- `type`: Тип (EAN13, EAN8, CODE128, INTERNAL, OTHER).
- `productId`: Ссылка на товар.

### Category (Категория)

Группировка товаров для удобства поиска и отчетности. Поддерживает иерархию.

- `id`: UUID (v7)
- `name`: Название категории.
- `parentId`: Ссылка на родительскую категорию (опционально).

### PriceType (Тип цены)

Определяет вид цены (например, "Розничная", "Оптовая").

- `id`: UUID (v7)
- `name`: Название типа цены.

### Price (Актуальная цена)

Конкретное значение цены для товара.

- `id`: UUID (v7)
- `value`: Значение цены (Decimal(15, 4)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `updatedAt`: Дата последнего изменения.
  **Особенность**: Уникальный индекс по паре `productId` + `priceTypeId`. Гарантирует, что у товара может быть только одна текущая цена каждого типа.

### PriceLedger (Реестр цен)

Строго неизменяемый (append-only) реестр всех изменений цен. Предназначен для аудита и восстановления истории.

- `id`: UUID (v7)
- `valueBefore`: Снимок цены ДО изменения.
- `value`: Новое значение цены (Decimal(15, 4)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `documentRevaluationId`: Ссылка на документ-основание (опционально).
- `date`: Дата "действия" цены (бизнес-время).
- `createdAt`: Системное время записи.

---

## Склады и Остатки

### Stock (Остаток на складе)

Текущее состояние товара на конкретном складе.

- `productId`: Ссылка на товар.
- `storeId`: Ссылка на склад.
- `quantity`: Текущее физическое количество (Decimal(12, 3)).
- `reserved`: Забронированное количество (товары в черновиках/планах) (Decimal(12, 3)).
- `averagePurchasePrice`: Средневзвешенная цена закупки (WAP/Себестоимость) (Decimal(15, 4)).

**Доступный остаток** для новых операций рассчитывается как: `quantity - reserved`.

---

## Документы

Все документы создаются пустыми (только заголовок), после чего товары добавляются через отдельные операции (`addItems`). Остатки обновляются только при переходе в статус `COMPLETED`.

### DocumentPurchase (Закупка)

Оприходование товара от поставщика. Обновляет количество и пересчитывает WAP.

- `code`: Номер документа с префиксом `P-`.
- `date`: Дата документа.
- `vendorId`: Ссылка на поставщика.
- `storeId`: Ссылка на склад.
- `total`: Общая сумма документа.
- `status`: Текущий статус.
- `revaluation`: Ссылка на автоматически созданный документ изменения цен (опционально).

**Управление позициями**:
Управление позициями во всех документах осуществляется гранулярно:

- Документ создается пустым (только заголовок).
- Товары добавляются, изменяются и удаляются через отдельные операции (`addItems`, `updateItem`, `removeItems`).
- Система автоматически пересчитывает `total` документа в реальном времени.

**Синхронизация с изменением цен**:
`DocumentPurchase` является мастер-документом для связанного `DocumentRevaluation`.

- При добавлении/редактировании позиции закупки с указанием "Новых цен" (`newPrices`), автоматически создается связанный документ изменения цен.
- Если документ изменения цен уже существует для этой закупки, новые позиции агрегируются (добавляются) в него.
- Если после удаления позиции или редактирования закупки список новых цен становится пустым, связанный документ изменения цен автоматически удаляется.
- Статусы документов жестко синхронизированы: переход закупки в `COMPLETED` автоматически переводит связанный документ в `COMPLETED`. Отмена или возврат в черновик также каскадно обновляет связанный документ.

### DocumentPurchaseItem (Позиция закупки)

- `purchaseId`: Ссылка на закупку.
- `productId`: Ссылка на товар.
- `quantity`: Количество (Decimal(12, 3)).
- `price`: Цена закупки (Decimal(15, 4)).
- `total`: Общая сумма по позиции.

### DocumentSale (Продажа)

Реализация товара клиенту. Уменьшает остатки, фиксирует цену продажи и себестоимость на момент продажи.

- `code`: Номер документа с префиксом `S-`.
- `storeId`: Ссылка на склад.
- `cashboxId`: Ссылка на кассу.
- `clientId`: Ссылка на клиента (необязательно).
- `priceTypeId`: Тип цены, по которой совершена продажа.
- `total`: Общая сумма.
- `status`: Текущий статус.

### DocumentSaleItem (Позиция продажи)

- `saleId`: Ссылка на продажу.
- `productId`: Ссылка на товар.
- `quantity`: Количество.
- `price`: Цена продажи.
- `costPrice`: Себестоимость (WAP) в момент продажи.
- `total`: Сумма.

### DocumentReturn (Возврат от клиента)

Возврат проданного товара. Увеличивает остатки. Не влияет на WAP (себестоимость).

- `code`: Номер документа с префиксом `R-`.
- `clientId`: Ссылка на клиента.
- `status`: Текущий статус.
- `items`: Список товаров (`DocumentReturnItem`).

### DocumentAdjustment (Инвентаризация/Корректировка)

Ручная корректировка остатков (излишки/недостачи).

- `code`: Номер документа с префиксом `A-`.
- `storeId`: Ссылка на склад.
- `status`: Текущий статус.
- `items`: Список товаров (`DocumentAdjustmentItem`). Включает снимки `quantityBefore` и `quantityAfter`.

### DocumentTransfer (Перемещение)

Перемещение товара между складами. Уменьшает остатки на складе-источнике и увеличивает на складе-получателе.

- `code`: Номер документа с префиксом `T-`.
- `sourceStoreId`: Откуда.
- `destinationStoreId`: Куда.
- `status`: Текущий статус.
- `items`: Список товаров.

### DocumentRevaluation (Изменение цен)

Документ для явного изменения розничных/оптовых цен.

- `code`: Номер документа с префиксом `RV-`.
- `date`: Дата вступления цен в силу.
- `status`: Текущий статус.
- `items`: Список товаров и новых цен (`DocumentRevaluationItem`).

**Особенности**:

- Если документ создан автоматически на основании `DocumentPurchase` (поле `documentPurchaseId` заполнено), его нельзя редактировать или менять его статус напрямую. Все управление должно происходить через родительский документ закупки.
- При проведении документа (`COMPLETED`) записи автоматически добавляются в `PriceLedger` и обновляют таблицу текущих цен `Price`.

### DocumentRevaluationItem (Позиция изменения цены)

Конкретное изменение цены для одного товара и типа цены в рамках документа.

- `documentId`: Ссылка на документ изменения цен.
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `oldValue`: Старое значение цены (Decimal).
- `newValue`: Новое значение цены (Decimal).

---

## Аудит движений и Пересчеты

### StockLedger (Реестр движения товаров)

Лог движения товаров. Неизменяемый (append-only) реестр всех изменений остатков. Реализует принцип **"Strict Storno"**: ошибки не исправляются изменением старых записей, а компенсируются созданием новых корректирующих записей.

- `id`: UUID (v7).
- `type`: Тип операции (`StockMovementType`: PURCHASE, SALE, RETURN, ADJUSTMENT, TRANSFER_IN, TRANSFER_OUT).
- `storeId`: Ссылка на магазин.
- `productId`: Ссылка на товар.
- `quantity`: Изменение количества (дельта). Отрицательное для расхода, положительное для прихода.
- `quantityBefore`: Остаток ДО операции.
- `quantityAfter`: Остаток ПОСЛЕ операции.
- `averagePurchasePrice`: Себестоимость единицы (WAP) на момент операции (Decimal(15, 4)).
- `transactionAmount`: Общая стоимость операции в учетных ценах.
- `date`: Дата операции (бизнес-время).
- `createdAt`: Физическое время создания записи.

**Поля для аудита и Storno:**

- `reason`: Причина записи (`LedgerReason`):
  - `INITIAL`: Обычная первичная запись.
  - `REVERSAL`: Сторнирующая запись (отмена). Полностью зеркальна оригинальной записи (инвертированное количество и сумма).
  - `CORRECTION`: Исправляющая запись. Вносится после REVERSAL, если нужно изменить параметры операции "задним числом".
- `parentLedgerId`: Ссылка на родительскую запись `StockLedger`, которую данная запись сторнирует или исправляет.
- `causationId`: ID "корневой" записи или события, послужившего причиной всей цепочки изменений. Используется для группировки связанных корректировок.
- `batchId`: ID документа, породившего движение (для группировки всех товаров одного чека/накладной).

### DocumentHistory (Журнал изменений документов)

Системный лог всех действий с документами.

- `action`: Действие (CREATED, UPDATED, STATUS_CHANGED и т.д.)
- `details`: JSON-объект с деталями изменений.
- `document[Type]Id`: Ссылка на соответствующий документ.

---

### Учет бронирования (Reservation)

Для предотвращения перепродаж (overselling) система реализует механизм бронирования остатков:

1.  **Бронирование**: При добавлении товаров в `DRAFT` или `SCHEDULED` документы продаж (`DocumentSale`) и перемещений (`DocumentTransfer`), количество товара автоматически суммируется в поле `Stock.reserved`.
2.  **Валидация**: Система блокирует добавление товара в документ, если новое количество превышает свободный остаток (`quantity - reserved`).
3.  **Переход в COMPLETED**:
    - Поле `reserved` уменьшается (бронь снимается).
    - Поле `quantity` уменьшается (физическое списание).
    - Создается запись в `StockLedger`.
4.  **Откат в DRAFT**: Физический остаток возвращается в `quantity`, и бронь `reserved` восстанавливается.
5.  **Очистка**: Система автоматически аннулирует "забытые" черновики старше 24 часов через Cron-задачу, освобождая заблокированные остатки.
