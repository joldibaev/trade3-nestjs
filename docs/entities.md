# Документация сущностей (Entities)

В этой документации описаны основные модели данных, используемые в системе учета товаров.

## Содержание
- [Базовые сущности](#базовые-сущности)
- [Товары и Цены](#товары-и-цены)
- [Склады и Остатки](#склады-и-остатки)
- [Документы](#документы)
- [Аудит движений](#аудит-движений)

---

## Базовые сущности

### Store (Склад/Магазин)
Представляет физическую точку хранения или продажи.
- `id`: UUID (v7)
- `name`: Название (уникальное)
- `cashboxes`: Список привязанных касс.
- `stocks`: Остатки товаров на этом складе.

### Cashbox (Касса)
Денежная точка, привязанная к конкретному складу. Используется в документах продажи.
- `id`: UUID (v7)
- `name`: Название кассы.
- `storeId`: Ссылка на склад.

### Vendor (Поставщик)
Юридическое или физическое лицо, у которого закупается товар.
- `id`: UUID (v7)
- `name`: Название поставщика.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

### Client (Клиент)
Покупатель товара. Используется в продажах и возвратах.
- `id`: UUID (v7)
- `name`: Имя/Название клиента.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

---

## Товары и Цены

### Product (Товар)
Основная единица учета.
- `id`: UUID (v7)
- `name`: Название товара.
- `article`: Артикул (необязательно).
- `categoryId`: Ссылка на категорию.
- `barcodes`: Список штрих-кодов товара.
- `stocks`: Состояние остатков на разных складах.

### Category (Категория)
Группировка товаров для удобства поиска и отчетности.
- `id`: UUID (v7)
- `name`: Название категории.

### PriceType (Тип цены)
Определяет вид цены (например, "Розничная", "Оптовая").
- `id`: UUID (v7)
- `name`: Название типа цены.

### Price (Цена)
Конкретное значение цены для товара и типа цены. **Хранит историю изменений.**
- `id`: UUID (v7)
- `value`: Значение цены (Decimal).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `documentPurchaseId`: Ссылка на документ закупки, который установил эту цену (необязательно).
- `createdAt`: Дата установки цены.
**Сортировка**: Актуальная цена — это запись с самой поздней датой создания для данной пары товар-тип цены.

---

## Склады и Остатки

### Stock (Остаток на складе)
Текущее состояние товара на конкретном складе.
- `productId_storeId`: Уникальный составной ключ.
- `quantity`: Текущее количество (Decimal).
- `averagePurchasePrice`: Средневзвешенная цена закупки (WAP/Себестоимость). Обновляется при закупках и перемещениях.

---

## Документы

Все документы имеют статус (`DocumentStatus`): `DRAFT`, `COMPLETED`, `CANCELLED`. Остатки обновляются только при статусе `COMPLETED`.

### DocumentPurchase (Закупка)
Оприходование товара от поставщика. Обновляет количество и пересчитывает WAP.
- `vendorId`: Ссылка на поставщика.
### DocumentPurchaseItem (Позиция закупки)
- `purchaseId`: Ссылка на закупку.
- `productId`: Ссылка на товар.
- `quantity`: Количество.
- `price`: Цена закупки.
- `newPrices`: Список отложенных обновлений цен (`DocumentPurchaseItemPrice`), которые вступят в силу при проведении документа.

### DocumentSale (Продажа)
Реализация товара клиенту. Уменьшает остатки, фиксирует цену продажи и себестоимость на момент продажи.
- `cashboxId`: Ссылка на кассу.
- `clientId`: Ссылка на клиента (необязательно).
- `priceTypeId`: Тип цены, по которой совершена продажа.
- `items`: Список товаров (`DocumentSaleItem`). Включает `costPrice` (себестоимость в момент продажи).

### DocumentReturn (Возврат от клиента)
Возврат проданного товара. Увеличивает остатки. Не влияет на WAP (себестоимость).
- `clientId`: Ссылка на клиента.
- `items`: Список товаров (`DocumentReturnItem`).

### DocumentAdjustment (Инвентаризация/Корректировка)
Ручная корректировка остатков (излишки/недостачи).
- `items`: Список товаров (`DocumentAdjustmentItem`). Включает `quantityBefore` и `quantityAfter`.

### DocumentTransfer (Перемещение)
Перемещение товара между складами. Уменьшает остатки на складе-источнике и увеличивает на складе-получателе (с пересчетом WAP получателя).
- `sourceStoreId`: Откуда.
- `destinationStoreId`: Куда.
- `items`: Список товаров.

---

## Аудит движений

### StockMovement (История движения товаров)
Точный аудит каждого изменения остатка. Позволяет построить отчет на любую дату.
- `type`: Тип движения (`PURCHASE`, `SALE`, `RETURN`, `ADJUSTMENT`, `TRANSFER_IN`, `TRANSFER_OUT`).
- `quantity`: Изменение (положительное или отрицательное).
- `quantityAfter`: Снимок (snapshot) остатка ПОСЛЕ операции.
- `averagePurchasePrice`: Снимок себестоимости в момент операции.
- **Связи**: Содержит прямые опциональные ссылки на все типы документов (`documentPurchaseId`, `documentSaleId` и т.д.).
