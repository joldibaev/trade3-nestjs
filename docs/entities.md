# Документация сущностей (Entities)

В этой документации описаны основные модели данных, используемые в системе учета товаров.

## Содержание

- [Базовые сущности](#базовые-сущности)
- [Товары и Цены](#товары-и-цены)
- [Склады и Остатки](#склады-и-остатки)
- [Документы](#документы)
- [Аудит движений и Пересчеты](#аудит-движений-и-пересчеты)

---

## Базовые сущности

### Store (Склад/Магазин)

Представляет физическую точку хранения или продажи.

- `id`: UUID (v7)
- `name`: Название (уникальное)
- `cashboxes`: Список привязанных касс.
- `stocks`: Остатки товаров на этом складе.

### Cashbox (Касса)

Денежная точка, привязанная к конкретному складу. Используется в документах продажи.

- `id`: UUID (v7)
- `name`: Название кассы.
- `storeId`: Ссылка на склад.

### Vendor (Поставщик)

Юридическое или физическое лицо, у которого закупается товар.

- `id`: UUID (v7)
- `name`: Название поставщика.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

### Client (Клиент)

Покупатель товара. Используется в продажах и возвратах.

- `id`: UUID (v7)
- `name`: Имя/Название клиента.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

---

## Товары и Цены

### Product (Товар)

Основная единица учета.

- `id`: UUID (v7)
- `name`: Название товара.
- `article`: Артикул (необязательно).
- `categoryId`: Ссылка на категорию.
- `barcodes`: Список штрих-кодов товара.
- `stocks`: Состояние остатков на разных складах.

### Category (Категория)

Группировка товаров для удобства поиска и отчетности.

- `id`: UUID (v7)
- `name`: Название категории.

### PriceType (Тип цены)

Определяет вид цены (например, "Розничная", "Оптовая").

- `id`: UUID (v7)
- `name`: Название типа цены.

### Price (Актуальная цена)

Конкретное значение цены для товара.

- `id`: UUID (v7)
- `value`: Значение цены (Decimal(12, 2)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `createdAt`: Дата последнего изменения.
  **Особенность**: Уникальный индекс по паре `productId` + `priceTypeId`. Гарантирует, что у товара может быть только одна текущая цена каждого типа. Это обеспечивает мгновенный поиск цены при продаже.

### PriceLedger (Реестр цен)

Строго неизменяемый (append-only) реестр всех изменений цен. Предназначен для аудита и восстановления истории.

- `id`: UUID (v7)
- `valueBefore`: Снимок цены ДО изменения. Позволяет видеть дельту и проверять целостность цепочки.
- `value`: Новое значение цены (Decimal(12, 2)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `documentPriceChangeId`: Ссылка на документ-основание.
- `date`: Дата "действия" цены (бизнес-время). 
- `createdAt`: Системное время записи.

**Паттерн "Срез последних":** 
Для определения текущей актуальной цены система выполняет поиск в этом реестре с сортировкой `ORDER BY date DESC, createdAt DESC LIMIT 1`. Это позволяет планировать изменение цен на будущее или вносить их задним числом.

**Принцип неизменяемости (Storno):** 
Если проведенный документ отменяется, старые записи в `PriceLedger` **не удаляются** и **не изменяются**. Вместо этого в реестр добавляется новая "корректирующая" запись (сторнирование), которая возвращает цену к значению `valueBefore`. Это обеспечивает 100% аудит управленческих решений.

---

## Склады и Остатки

### Stock (Остаток на складе)

Текущее состояние товара на конкретном складе.

- `productId_storeId`: Уникальный составной ключ.
- `quantity`: Текущее количество (Decimal(12, 3)).
- `averagePurchasePrice`: Средневзвешенная цена закупки (WAP/Себестоимость) (Decimal(12, 2)). Обновляется при закупках и перемещениях.

---

Все документы имеют статус (`DocumentStatus`): `DRAFT`, `COMPLETED`, `CANCELLED`, `SCHEDULED`. Остатки обновляются только при статусе `COMPLETED`. 
`SCHEDULED` — статус для документов с будущей датой. Они автоматически переходят в `COMPLETED` при наступлении указанного времени. 

**Важно:** Проведение документа задним числом или отмена проведенного документа автоматически инициирует [процесс пересчета истории](#inventoryreprocessing-пересчет-истории).

### DocumentPurchase (Закупка)

Оприходование товара от поставщика. Обновляет количество и пересчитывает WAP. 
Может автоматически создавать связанный документ `DocumentPriceChange` для изменения цен продажи, если указаны `newPrices` для позиций.


- `code`: Номер документа (автоинкремент).
- `vendorId`: Ссылка на поставщика.
- `documentPriceChangeId`: Ссылка на автоматически созданный документ изменения цен (опционально).


### DocumentPurchaseItem (Позиция закупки)

- `purchaseId`: Ссылка на закупку.
- `productId`: Ссылка на товар.
- `quantity`: Количество (Decimal(12, 3)).
- `newPrices`: Массив новых цен (обновляет связанные цены в `DocumentPriceChange`).


### DocumentSale (Продажа)

Реализация товара клиенту. Уменьшает остатки, фиксирует цену продажи и себестоимость на момент продажи.

- `code`: Номер документа (автоинкремент).
- `cashboxId`: Ссылка на кассу.
- `clientId`: Ссылка на клиента (необязательно).
- `priceTypeId`: Тип цены, по которой совершена продажа.
- `items`: Список товаров (`DocumentSaleItem`). Включает `costPrice` (себестоимость в момент продажи).

### DocumentReturn (Возврат от клиента)

Возврат проданного товара. Увеличивает остатки. Не влияет на WAP (себестоимость).

- `code`: Номер документа (автоинкремент).
- `clientId`: Ссылка на клиента.
- `items`: Список товаров (`DocumentReturnItem`).

### DocumentAdjustment (Инвентаризация/Корректировка)

Ручная корректировка остатков (излишки/недостачи).

- `code`: Номер документа (автоинкремент).
- `items`: Список товаров (`DocumentAdjustmentItem`). Включает `quantityBefore` и `quantityAfter`.

### DocumentTransfer (Перемещение)

Перемещение товара между складами. Уменьшает остатки на складе-источнике и увеличивает на складе-получателе (с пересчетом WAP получателя).

- `code`: Номер документа (автоинкремент).
- `sourceStoreId`: Откуда.
- `destinationStoreId`: Куда.
- `items`: Список товаров.

---

### DocumentPriceChange (Изменение цен)

Документ для явного изменения розничных/оптовых цен.

- `code`: Номер документа.
- `date`: Дата вступления цен в силу.
- `items`: Список товаров и новых цен.
- `status`: `DRAFT` -> `COMPLETED` (пишет в `PriceLedger`).

---

## Аудит движений и Пересчеты

### StockLedger (Реестр движения товаров)

Лог движения товаров. Является неизменяемым (append-only) реестром всех изменений остатков.

**Паттерн "Поток" (Flow):**
В отличие от цен, количество — это поток. Текущий остаток — это сумма всех записей в этом реестре. Каждая запись неразрывно связана с предыдущей через снимки состояния.

### Поля

- `id`: UUID
- `type`: Тип операции (PURCHASE, SALE, RETURN, ADJUSTMENT, TRANSFER_IN, TRANSFER_OUT)
- `storeId`: Ссылка на магазин
- `productId`: Ссылка на товар
- `quantity`: Изменение количества (дельта). Положительное (приход) или отрицательное (расход).
- `quantityBefore`: Остаток ДО операции (Snapshot).
- `quantityAfter`: Остаток ПОСЛЕ операции (Snapshot). **Критически важно:** `quantityAfter` текущей записи должен всегда совпадать с `quantityBefore` следующей по времени записи для этого товара на этом складе.
- `averagePurchasePrice`: Себестоимость единицы (WAP) на момент операции.
- `transactionAmount`: Общая стоимость операции в денежном выражении (quantity \* price/cost).
- `batchId`: Группировка движений в рамках одного документа.
- `date`: Дата операции (бизнес-время)
- `createdAt`: Дата создания записи (системное время)

**Принцип сторнирования:**
При отмене документа (например, закупки) система не удаляет запись о приходе, а создает новую запись в `StockLedger` с типом операции и отрицательным количеством. Это сохраняет историю того, что товар физически "заходил" на склад, а затем был списан из-за отмены документа.

- Связан с одним из документов-оснований (`DocumentPurchase`, `DocumentSale` и т.д.) через специфические ID поля.

---

### InventoryReprocessing (Пересчет истории)

Системный документ, фиксирующий факт и результат пересчета хронологической истории движений товара. Создается автоматически при изменении "прошлого" (заднее число, отмена старых документов).

- `id`: UUID (v7)
- `date`: Дата, с которой начат пересчет (бизнес-время).
- `status`: Состояние (`PENDING`, `COMPLETED`, `FAILED`).
- `document[Type]Id`: Ссылка на документ-первоисточник, вызвавший пересчет (Purchases, Sale, Transfer и т.д.).
- `items`: Детализация пересчета по каждому товару и складу (`InventoryReprocessingItem`).

### InventoryReprocessingItem (Результат пересчета)

Конкретный результат пересчета для пары Товар-Склад.

- `productId`: Ссылка на товар.
- `storeId`: Ссылка на склад.
- `oldAveragePurchasePrice`: Себестоимость (WAP) ДО пересчета.
- `newAveragePurchasePrice`: Себестоимость (WAP) ПОСЛЕ пересчета.
- `oldQuantity`: Остаток ДО пересчета.
- `newQuantity`: Остаток ПОСЛЕ пересчета.
- `affectedLedgerCount`: Количество затронутых записей в `StockLedger`, которые были обновлены в процессе.
- `createdAt`: Дата фиксации результата.
