# Документация сущностей (Entities)

В этой документации описаны основные модели данных, используемые в системе учета товаров.

## Содержание

- [Базовые сущности](#базовые-сущности)
- [Товары и Цены](#товары-и-цены)
- [Склады и Остатки](#склады-и-остатки)
- [Документы](#документы)
- [Аудит движений](#аудит-движений)

---

## Базовые сущности

### Store (Склад/Магазин)

Представляет физическую точку хранения или продажи.

- `id`: UUID (v7)
- `name`: Название (уникальное)
- `cashboxes`: Список привязанных касс.
- `stocks`: Остатки товаров на этом складе.

### Cashbox (Касса)

Денежная точка, привязанная к конкретному складу. Используется в документах продажи.

- `id`: UUID (v7)
- `name`: Название кассы.
- `storeId`: Ссылка на склад.

### Vendor (Поставщик)

Юридическое или физическое лицо, у которого закупается товар.

- `id`: UUID (v7)
- `name`: Название поставщика.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

### Client (Клиент)

Покупатель товара. Используется в продажах и возвратах.

- `id`: UUID (v7)
- `name`: Имя/Название клиента.
- `phone`: Телефон.
- `email`: Email.
- `address`: Адрес.

---

## Товары и Цены

### Product (Товар)

Основная единица учета.

- `id`: UUID (v7)
- `name`: Название товара.
- `article`: Артикул (необязательно).
- `categoryId`: Ссылка на категорию.
- `barcodes`: Список штрих-кодов товара.
- `stocks`: Состояние остатков на разных складах.

### Category (Категория)

Группировка товаров для удобства поиска и отчетности.

- `id`: UUID (v7)
- `name`: Название категории.

### PriceType (Тип цены)

Определяет вид цены (например, "Розничная", "Оптовая").

- `id`: UUID (v7)
- `name`: Название типа цены.

### Price (Актуальная цена)

Конкретное значение цены для товара.

- `id`: UUID (v7)
- `value`: Значение цены (Decimal(12, 2)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `createdAt`: Дата последнего изменения.
  **Особенность**: Уникальный индекс по паре `productId` + `priceTypeId`. Гарантирует, что у товара может быть только одна текущая цена каждого типа. Это обеспечивает мгновенный поиск цены при продаже.

### PriceLedger (Реестр цен)

Неизменяемый реестр всех изменений цен.

- `id`: UUID (v7)
- `value`: Историческое значение цены (Decimal(12, 2)).
- `productId`: Ссылка на товар.
- `priceTypeId`: Ссылка на тип цены.
- `documentPriceChangeId`: Ссылка на документ изменения цен (основной источник).
- `date`: Дата "действия" цены. Используется для определения текущей актуальной цены по методу "Срез последних".
- `createdAt`: Когда эта запись была физически добавлена в базу.

---

## Склады и Остатки

### Stock (Остаток на складе)

Текущее состояние товара на конкретном складе.

- `productId_storeId`: Уникальный составной ключ.
- `quantity`: Текущее количество (Decimal(12, 3)).
- `averagePurchasePrice`: Средневзвешенная цена закупки (WAP/Себестоимость) (Decimal(12, 2)). Обновляется при закупках и перемещениях.

---

## Документы

Все документы имеют статус (`DocumentStatus`): `DRAFT`, `COMPLETED`, `CANCELLED`. Остатки обновляются только при статусе `COMPLETED`.

### DocumentPurchase (Закупка)

Оприходование товара от поставщика. Обновляет количество и пересчитывает WAP.

- `code`: Номер документа (автоинкремент).
- `vendorId`: Ссылка на поставщика.

### DocumentPurchaseItem (Позиция закупки)

- `purchaseId`: Ссылка на закупку.
- `productId`: Ссылка на товар.
- `quantity`: Количество (Decimal(12, 3)).

### DocumentSale (Продажа)

Реализация товара клиенту. Уменьшает остатки, фиксирует цену продажи и себестоимость на момент продажи.

- `code`: Номер документа (автоинкремент).
- `cashboxId`: Ссылка на кассу.
- `clientId`: Ссылка на клиента (необязательно).
- `priceTypeId`: Тип цены, по которой совершена продажа.
- `items`: Список товаров (`DocumentSaleItem`). Включает `costPrice` (себестоимость в момент продажи).

### DocumentReturn (Возврат от клиента)

Возврат проданного товара. Увеличивает остатки. Не влияет на WAP (себестоимость).

- `code`: Номер документа (автоинкремент).
- `clientId`: Ссылка на клиента.
- `items`: Список товаров (`DocumentReturnItem`).

### DocumentAdjustment (Инвентаризация/Корректировка)

Ручная корректировка остатков (излишки/недостачи).

- `code`: Номер документа (автоинкремент).
- `items`: Список товаров (`DocumentAdjustmentItem`). Включает `quantityBefore` и `quantityAfter`.

### DocumentTransfer (Перемещение)

Перемещение товара между складами. Уменьшает остатки на складе-источнике и увеличивает на складе-получателе (с пересчетом WAP получателя).

- `code`: Номер документа (автоинкремент).
- `sourceStoreId`: Откуда.
- `destinationStoreId`: Куда.
- `items`: Список товаров.

---

### DocumentPriceChange (Изменение цен)

Документ для явного изменения розничных/оптовых цен.

- `code`: Номер документа.
- `date`: Дата вступления цен в силу.
- `items`: Список товаров и новых цен.
- `status`: `DRAFT` -> `COMPLETED` (пишет в `PriceLedger`).

---

## Аудит движений

### StockLedger (Реестр движения товаров)

Лог движения товаров. Является неизменяемым (append-only) реестром всех изменений остатков.

### Поля

- `id`: UUID
- `type`: Тип операции (PURCHASE, SALE, RETURN, ADJUSTMENT, TRANSFER_IN, TRANSFER_OUT)
- `storeId`: Ссылка на магазин
- `productId`: Ссылка на товар
- `quantity`: Изменение количества (дельта). Положительное (приход) или отрицательное (расход).
- `quantityBefore`: Остаток ДО операции (Snapshot).
- `quantityAfter`: Остаток ПОСЛЕ операции (Snapshot).
- `averagePurchasePrice`: Себестоимость единицы (WAP) на момент операции.
- `transactionAmount`: Общая стоимость операции в денежном выражении (quantity \* price/cost).
- `batchId`: Группировка движений в рамках одной логической транзакции (например, один документ).
- `quantityAfter`: Остаток ПОСЛЕ операции (Snapshot).
- `date`: Дата операции (бизнес-время)
- `createdAt`: Дата создания записи (системное время)

### Связи

- Связан с одним из документов-оснований (`DocumentPurchase`, `DocumentSale` и т.д.)
