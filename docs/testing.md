# Тестирование (E2E Testing)

В этом документе описана стратегия End-to-End (E2E) тестирования приложения. Мы фокусируемся на проверке поведения системы с точки зрения пользователя, взаимодействуя исключительно через публичное API.

## Стратегия

Тесты **обязательно** должны использовать `TestHelper` для всех операций создания данных. Это критически важно для корректной очистки базы данных после тестов.

**Правила написания тестов:**

1.  **Создание данных:** Использовать ТОЛЬКО методы `TestHelper` (`createStore`, `createVendor`, `createProduct` и т.д.). Эти методы автоматически регистрируют созданные ID для последующего удаления.
    - _Запрещено_ использовать прямые вызовы `prisma.model.create(...)` в тестах, если вы вручную не трекаете ID в `helper.createdIds`.
    - _Запрещено_ использовать `request(...).post(...)` для создания сущностей, если вы вручную не трекаете ID.
2.  **Взаимодействие:** Для тестируемых сценариев использовать `supertest` (`request(app)`) как клиент.
3.  **Очистка (Cleanup):**
    - В блоке `afterAll` (и `beforeEach` при необходимости) **обязательно** вызывать `await helper.cleanup()`.
    - `TestHelper.cleanup()` удаляет данные в порядке обратном зависимостям, используя список `createdIds`.
4.  **Проверка утечек (Regression):** Существует спец-тест `z-garbage-check.e2e-spec.ts`, который запускается последним и проверяет отсутствие "мусора" (данных с тестовыми префиксами) в БД.

## Test Helper (`test-helper.ts`)

Класс-помощник, инкапсулирующий рутину по настройке окружения.

- `createdIds`: Публичный реестр созданных ID для очистки.
- `createStore`, `createProduct`: Создание справочников через Prisma с регистрацией ID.
- **Создание документов (гранулярный подход):**
  - `createPurchase`, `createSale`, `createReturn`, `createTransfer`, `createAdjustment`: Используют **3-этапный процесс**:
    1. POST `/document-{type}` - создание заголовка документа (DRAFT)
    2. POST `/document-{type}/{id}/items` - добавление позиций (поддерживает массовое добавление через массив `items`)
    3. PATCH `/document-{type}/{id}/status` - изменение статуса (если нужно COMPLETED)
  - Все методы возвращают **полный документ** через финальный GET запрос для консистентности
  - Параметр `expectedStatus` применяется к операции изменения статуса, а не к созданию документа
  - **Даты**: По умолчанию создают документы с датой "вчера" (`Date.now() - 24h`). Это гарантирует, что документы сразу перейдут в статус `COMPLETED` и не будут автоматически запланированы (`SCHEDULED`). Для тестирования планировщика используйте явную передачу будущей даты.

- `completePurchase`, `completeSale`: Отправка PATCH-запросов для смены статуса.
- `cleanup`: Каскадное удаление данных на основе `createdIds`.

### Подавление логов ошибок

В E2E тестах логирование ошибок отключено через `vitest-setup.ts` для предотвращения "шума" в выводе тестов. Ошибки валидации и конкурентности (например, "Insufficient stock", "Transaction write conflict") являются ожидаемым поведением и корректно обрабатываются тестами.

## Тестовые наборы (`specs`)

### 1. Справочники (Master Data)

**Ответственность:** Проверка CRUD операций для основных сущностей.

- **`master-catalog.e2e-spec.ts`**:
  - **Category:** Создание древовидных каталогов, переименование, удаление.
  - **Product:** Создание товаров, привязка к категориям, обновление.
  - **Barcode:** Добавление штрихкодов. Проверка каскадного удаления (удаление товара удаляет и штрихкоды).
  - **Price / PriceType:** Создание типов цен и установка цен на товары.

- **`master-partners.e2e-spec.ts`**:
  - **Vendor / Client:** Создание, обновление и удаление поставщиков и клиентов.

- **`master-org.e2e-spec.ts`**:
  - **Store / Cashbox:** Управление структурой магазинов и касс.

- **`product-search.e2e-spec.ts`**:
  - **Product Search:** Поиск товаров по названию, артикулу и штрихкоду. Проверка регистронезависимости.

### 2. CRUD Операции (`document-crud.e2e-spec.ts`)

**Ответственность:** Проверка базовых операций: Создание, Чтение, Обновление, Удаление док-ов.
**Кейсы:**

- Создание и редактирование документов в статусе DRAFT.
- Попытка удаления или редактирования проведенного (COMPLETED) документа (должна быть ошибка).

### 3. Статусная модель и Остатки (`*-status.e2e-spec.ts`)

**Ответственность:** Проверка движения остатков при смене статусов.

- **`document-purchase-status`**:
  - Откат остатков при смене COMPLETED -> DRAFT.
  - Блокировка отката, если товар уже продан (уход в минус).
  - Статус CANCELLED работает аналогично DRAFT (снимает резерв/остаток).

- **`document-sale-status`**:
  - Возврат товара на склад при отмене продажи.
  - Идемпотентность (повторная отправка того же статуса не ломает учет).

- **`document-return-status`**:
  - Увеличение остатка при возврате от клиента.
  - Блокировка отмены возврата, если этот товар уже перепродан.

### 4. Бизнес-логика и Атомарность

**Ответственность:** Проверка специфичных правил и транзакционности.

- **`document-sale.e2e-spec.ts`**:
  - Уменьшение остатков при продаже
  - Неизменность WAP при продаже
  - Проверка статусной модели (DRAFT → COMPLETED)
  - _Примечание:_ Тест атомарности (отклонение всего чека при невалидной позиции) был удален, так как с гранулярным подходом позиции добавляются по одной

- **`document-purchase.e2e-spec.ts`**:
  - **Отложенное** обновление цен продажи (`newPrices`): цены сохраняются в документе и применяются только при проведении.
  - Пересчет себестоимости (WAP).

- **`document-purchase-price-logic.e2e-spec.ts`**:
  - Автоматическое создание `DocumentPriceChange` при добавлении позиций с новыми ценами
  - Сохранение изменений цен для нескольких товаров в одном документе

- **`document-transfer`** и **`document-adjustment`**:
  - Перемещение между складами (проверка наличия остатка на источнике).
  - Инвентаризация (списание недостач, оприходование излишков).

### 5. Сложные сценарии

- **`stock-movement.e2e-spec.ts`**:
  - Проверка аудита (`StockLedger`). Убеждается, что каждое движение товара записывается в лог с фиксацией цены и остатка "до/после".

- **`aa-stress-concurrency.e2e-spec.ts`**:
  - **Конкурентность:** Симуляция параллельных продаж одного товара (Stress Test). Проверка корректной обработки блокировок БД (чтобы не продать больше, чем есть). Использует `Promise.all` для одновременных запросов.

- **`sequence-reprocessing.e2e-spec.ts`**:
  - **Time Travel:** Проверка пересчета истории. Отменяется старая закупка, проверяется, что себестоимость в последующих продажах корректно обновилась.
