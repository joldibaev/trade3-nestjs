# Тестирование (E2E Testing)

В этом документе описана стратегия End-to-End (E2E) тестирования приложения. Мы фокусируемся на проверке поведения системы с точки зрения пользователя, взаимодействуя исключительно через публичное API.

## Стратегия

Тесты **не используют** прямые вызовы сервисов (например, `DocumentSaleService.create`) для выполнения действий. Вместо этого используется `supertest` для отправки HTTP-запросов и `PrismaService` для подготовки данных.

**Ключевые принципы:**
*   **Подготовка (Setup):** Использование `TestHelper` (через `PrismaService`) для быстрого создания справочников (Склады, Товары, Контрагенты) напрямую в БД.
*   **Взаимодействие (Interaction):** Использование `supertest` (`request(app)`) для создания и проводки документов. Это эмулирует реального клиента.
*   **Валидация (Validation):** Проверка HTTP-кодов (201, 200, 400) и тел ответов. Проверка побочных эффектов (изменение остатков) через `helper.getStock`.
*   **Очистка (Cleanup):** Строгая очистка данных после каждого теста в `TestHelper` (удаление в порядке зависимостей), чтобы избежать конфликтов внешних ключей.

## Test Helper (`test-helper.ts`)

Класс-помощник, инкапсулирующий рутину по настройке окружения.

*   `createStore`, `createProduct`: Создание справочников через Prisma.
*   `createPurchase`, `createSale`, `createReturn`, ...: Отправка POST-запросов на создание документов. Поддерживает аргументы `status` (DRAFT/COMPLETED/CANCELLED) и ожидаемый код ответа (`expectedStatus`) для негативных тестов.
*   `completePurchase`, `completeSale`: Отправка PATCH-запросов для смены статуса.
*   `cleanup`: Каскадное удаление данных.

## Тестовые наборы (`specs`)

### 1. Справочники (Master Data)
**Ответственность:** Проверка CRUD операций для основных сущностей.

*   **`master-catalog.e2e-spec.ts`**:
    *   **Category:** Создание древовидных каталогов, переименование, удаление.
    *   **Product:** Создание товаров, привязка к категориям, обновление.
    *   **Barcode:** Добавление штрихкодов. Проверка каскадного удаления (удаление товара удаляет и штрихкоды).
    *   **Price / PriceType:** Создание типов цен и установка цен на товары.

*   **`master-partners.e2e-spec.ts`**:
    *   **Vendor / Client:** Создание, обновление и удаление поставщиков и клиентов.

*   **`master-org.e2e-spec.ts`**:
    *   **Store / Cashbox:** Управление структурой магазинов и касс.
    *   **User:** Создание и удаление пользователей.

### 2. CRUD Операции (`document-crud.e2e-spec.ts`)
**Ответственность:** Проверка базовых операций: Создание, Чтение, Обновление, Удаление док-ов.
**Кейсы:**
*   Создание и редактирование документов в статусе DRAFT.
*   Попытка удаления или редактирования проведенного (COMPLETED) документа (должна быть ошибка).

### 3. Статусная модель и Остатки (`*-status.e2e-spec.ts`)
**Ответственность:** Проверка движения остатков при смене статусов.

*   **`document-purchase-status`**:
    *   Откат остатков при смене COMPLETED -> DRAFT.
    *   Блокировка отката, если товар уже продан (уход в минус).
    *   Статус CANCELLED работает аналогично DRAFT (снимает резерв/остаток).

*   **`document-sale-status`**:
    *   Возврат товара на склад при отмене продажи.
    *   Идемпотентность (повторная отправка того же статуса не ломает учет).

*   **`document-return-status`**:
    *   Увеличение остатка при возврате от клиента.
    *   Блокировка отмены возврата, если этот товар уже перепродан.

### 4. Бизнес-логика и Атомарность
**Ответственность:** Проверка специфичных правил и транзакционности.

*   **`document-sale.e2e-spec.ts`**:
    *   **Атомарность:** Если одна позиция в чеке невалидна, весь чек должен отклониться, а остатки не должны списаться.
    *   Валидация некорректных данных.

*   **`document-purchase.e2e-spec.ts`**:
    *   Обновление цен продажи (`newPrices`) при закупке.
    *   Пересчет себестоимости (WAP).

*   **`document-transfer`** и **`document-adjustment`**:
    *   Перемещение между складами (проверка наличия остатка на источнике).
    *   Инвентаризация (списание недостач, оприходование излишков).

### 5. Сложные сценарии

*   **`stock-movement.e2e-spec.ts`**:
    *   Проверка аудита (`StockMovement`). Убеждается, что каждое движение товара записывается в лог с фиксацией цены и остатка "до/после".

*   **`document-status-concurrency.e2e-spec.ts`**:
    *   **Конкурентность:** Симуляция параллельных продаж одного товара. Проверка корректной обработки блокировок БД (чтобы не продать больше, чем есть).
