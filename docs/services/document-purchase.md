# DocumentPurchaseService (Закупки)

Этот сервис отвечает за создание и управление документами закупки товаров у поставщиков.

## Методы

### `create(dto: CreateDocumentPurchaseDto)`
Основной метод создания закупки. Выполняет следующие шаги в строгом порядке:

1.  **Валидация**:
    *   Проверяет существование склада (`storeId`) через `InventoryService`.
2.  **Транзакция** (`Serializable`):
    *   Создает запись `DocumentPurchase` с суммой 0.
    *   **Позиции**: Позиции товаров (items) **не создаются** на этом этапе, даже если переданы в DTO (они игнорируются или DTO их не содержит).
    *   **Статус документа**: Создается в статусе `DRAFT`.
    *   **Склад**: Остатки и WAP **не изменяются**.

### `update(id: string, dto: UpdateDocumentPurchaseDto)`
Позволяет добавить или обновить позиции товаров и метаданные.

*   **Ограничение**: Доступно только для документов в статусе **DRAFT**.
*   **Логика**:
    *   Удаляет все существующие `items`.
    *   Создает новые `items` из DTO.
    *   Обновляет метаданные документа (дата, поставщик и т.д.).
    *   Автоматически пересчитывает `totalAmount`.

### `remove(id: string)`
Удаляет документ.
*   **Ограничение**: Доступно только для документов в статусе **DRAFT**.
*   **Действие**: Удаляет сам документ и все связанные с ним позиции.

### `findAll(include?)`
Возвращает список всех закупок.
*   **Сортировка**: От новых к старым (`createdAt: 'desc'`).
*   **Параметры**: Позволяет через `include` подгрузить связанные данные (склад, поставщик, позиции).

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Этот метод управляет изменением статуса документа закупки (например, проведение или отмена) и выполняет всю связанную бизнес-логику в рамках транзакции.

Вот что происходит по шагам:

1.  **Транзакция (`isolationLevel: 'Serializable'`)**:
    *   Весь процесс обернут в строгую транзакцию для защиты от гонки данных при пересчете остатков и себестоимости.

2.  **Загрузка данных**:
    *   Получает документ со всеми позициями (`items`) и новыми ценами (`newPrices`).
    *   Если статус не меняется, просто возвращает документ.

3.  **Валидация**:
    *   Запрещает изменение статуса, если документ уже `CANCELLED` (Отменен).

4.  **Сценарий: Проведение (DRAFT -> COMPLETED)**:
    *   **Движение товара**: Вызывает `applyInventoryMovements`, который:
        *   Увеличивает остаток на складе (`Stock`).
        *   Пересчитывает средневзвешенную цену закупки (WAP).
        *   Создает запись в истории движений (`StockMovement`) с типом `PURCHASE`.
    *   **Обновление цен**: Вызывает `applyDelayedProductPriceUpdates`, чтобы применить новые розничные цены, указанные в закупке (обновляет таблицу `Price` и пишет в историю `PriceHistory`).

5.  **Сценарий: Отмена проведения (COMPLETED -> DRAFT / CANCELLED)**:
    *   **Проверка стока**: `validateStockForRevert` проверяет, достаточно ли товара на складе для отмены (не ушел ли он уже в минус) и не станет ли стоимость склада отрицательной.
    *   **Откат движения**: Вызывает `applyInventoryMovements` с **отрицательным количеством**, чтобы:
        *   Уменьшить остаток.
        *   Скорректировать WAP (удалить влияние этой закупки).
    *   **Подготовка к пересчету**: Собирает список товаров (`itemsToReprocess`), историю которых нужно пересчитать, так как изменение старой закупки влияет на себестоимость будущих продаж.

6.  **Обновление статуса**:
    *   Меняет статус самого документа в БД.

7.  **Пересчет истории (Sequence Reprocessing)**:
    *   Выполняется **после** завершения основной транзакции (чтобы не блокировать базу надолго).
    *   Для каждого затронутого товара вызывает `inventoryService.reprocessProductHistory`, который хронологически пересчитывает WAP и остатки всех последующих операций, начиная с даты этой закупки.

Таким образом, метод гарантирует корректность остатков, цен и истории даже при отмене старых документов.

## Особенности
*   **Изоляция**: Используется уровень `Serializable`, чтобы гарантировать, что параллельные закупки одного и того же товара правильно пересчитают WAP.
*   **Интеграция**: Плотно взаимодействует с `InventoryService` для валидации и логирования аудита.
