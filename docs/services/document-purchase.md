# DocumentPurchaseService (Закупки)

Этот сервис отвечает за создание и управление документами закупки товаров у поставщиков.

## Методы

### `create(dto: CreateDocumentPurchaseDto)`

Основной метод создания закупки.

- **Items**: Опциональны.
- **Status**: По умолчанию `DRAFT`.

1.  **Валидация**:
    - Проверяет существование склада (`storeId`) через `InventoryService`.
2.  **Транзакция** (`Serializable`):
    - Создает запись `DocumentPurchase` с суммой 0.
    - Если переданы позиции (`items`), создает их и рассчитывает сумму.
    - **Склад**: Остатки и WAP **не изменяются**, пока статус `DRAFT`.
3. ** Автоматическое изменение цен**:
    - Если в DTO для позиций передано поле `newPrice`, система автоматически создает связанный документ `DocumentPriceChange` в статусе **DRAFT**.
    - В этом документе будут зафиксированы новые цены на товары.
    - Ссылка на созданный документ сохраняется в поле `generatedPriceChange`.

### `update(id: string, dto: UpdateDocumentPurchaseDto)`

Позволяет добавить или обновить позиции товаров и метаданные.

- **Ограничение**: Доступно только для документов в статусе **DRAFT**.
- **Логика**:
  - Удаляет все существующие `items`.
  - Создает новые `items` из DTO.
  - Обновляет метаданные документа (дата, поставщик и т.д.).
  - Автоматически пересчитывает `total`.

### `remove(id: string)`

Удаляет документ.

- **Ограничение**: Доступно только для документов в статусе **DRAFT**.
- **Действие**: Удаляет сам документ и все связанные с ним позиции.

### `findAll(include?)`

Возвращает список всех закупок.

- **Сортировка**: От новых к старым (`createdAt: 'desc'`).
- **Параметры**: Позволяет через `include` подгрузить связанные данные (склад, поставщик, позиции).

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`

Этот метод управляет изменением статуса документа закупки (например, проведение или отмена) и выполняет всю связанную бизнес-логику в рамках транзакции.

Вот что происходит по шагам:

1.  **Транзакция (`isolationLevel: 'Serializable'`)**:
    - Весь процесс обернут в строгую транзакцию для защиты от гонки данных при пересчете остатков и себестоимости.

2.  **Загрузка данных**:
    - Получает документ со всеми позициями (`items`).
    - Если статус не меняется, просто возвращает документ.

3.  **Валидация**:
    - Запрещает изменение статуса, если документ уже `CANCELLED` (Отменен).

4.  **Сценарий: Проведение (DRAFT -> COMPLETED)**:
    - **Движение товара**: Вызывает `applyInventoryMovements`, который:
      - Увеличивает остаток на складе (`Stock`).
      - Пересчитывает средневзвешенную цену закупки (WAP).
      - Создает запись в истории движений (`StockLedger`) с типом `PURCHASE`.


5.  **Сценарий: Отмена проведения (COMPLETED -> DRAFT / CANCELLED)**:
    - **Проверка стока**: `validateStockForRevert` проверяет, достаточно ли товара на складе для отмены (не ушел ли он уже в минус) и не станет ли стоимость склада отрицательной.
    - **Откат движения**: Вызывает `applyInventoryMovements` с **отрицательным количеством**, чтобы:
      - Уменьшить остаток.
      - Скорректировать WAP (удалить влияние этой закупки).
    - **Подготовка к пересчету**: Собирает список товаров (`itemsToReprocess`), историю которых нужно пересчитать, так как изменение старой закупки влияет на себестоимость будущих продаж.

6.  **Обновление статуса**:
    - Меняет статус самого документа в БД.

7.  **Пересчет истории (Sequence Reprocessing)**:
    - Выполняется **после** завершения основной транзакции (чтобы не блокировать базу надолго).
    - Если документ занесен задним числом или его статус изменен с `COMPLETED`, автоматически создается системный документ `InventoryReprocessing`.
    - Для каждого затронутого товара вызывает `inventoryService.reprocessProductHistory`, который хронологически пересчитывает WAP и остатки всех последующих операций.
    - Итоговые изменения (старые и новые значения) логируются в `InventoryReprocessingItem` для полного аудита.

Таким образом, метод гарантирует корректность остатков, цен и истории даже при исправлении ошибок в документах за прошлые периоды.

## Особенности

- **Изоляция**: Используется уровень `Serializable`, чтобы гарантировать, что параллельные закупки одного и того же товара правильно пересчитают WAP.
- **Интеграция**: Плотно взаимодействует с `InventoryService` для валидации и логирования аудита.
