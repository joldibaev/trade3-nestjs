# DocumentPurchaseService (Закупки)

Этот сервис отвечает за создание и управление документами закупки товаров у поставщиков.

## Методы

### `create(dto: CreateDocumentPurchaseDto)`
Основной метод создания закупки. Выполняет следующие шаги в строгом порядке:

1.  **Валидация**:
    *   Проверяет существование склада (`storeId`) через `InventoryService`.
    *   Проверяет существование всех указанных товаров (`productId`).
2.  **Подготовка данных**:
    *   Конвертирует количество и цены в формат `Decimal`.
    *   Рассчитывает сумму по каждой позиции и общий итог документа.
3.  **Транзакция** (`Serializable`):
    *   Создает запись `DocumentPurchase` и связанные `DocumentPurchaseItem`.
    *   **Статус документа**: Создается в статусе `DRAFT`.
    *   **Отложенные данные**: Сохраняет `newPrices` (обновления цен) в связанных записях `DocumentPurchaseItemPrice`, но **не применяет** их к справочнику цен.
    *   **Склад**: Остатки и WAP **не изменяются** при создании (только при проведении).

### `update(id: string, dto: CreateDocumentPurchaseDto)`
Позволяет полностью заменить содержимое документа.
*   **Ограничение**: Доступно только для документов в статусе **DRAFT**.
*   **Логика**:
    *   Удаляет все существующие `items`.
    *   Создает новые `items` из DTO.
    *   Обновляет метаданные документа (дата, поставщик и т.д.).
    *   Автоматически пересчитывает `totalAmount`.

### `remove(id: string)`
Удаляет документ.
*   **Ограничение**: Доступно только для документов в статусе **DRAFT**.
*   **Действие**: Удаляет сам документ и все связанные с ним позиции.

### `findAll(include?)`
Возвращает список всех закупок.
*   **Сортировка**: От новых к старым (`createdAt: 'desc'`).
*   **Параметры**: Позволяет через `include` подгрузить связанные данные (склад, поставщик, позиции).

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Позволяет изменять статус документа.
*   **DRAFT -> COMPLETED**:
    *   Проводит документ. Зачисляет товар на склад, пересчитывает WAP.
    *   Применяет отложенные обновления цен (`newPrices`), сохраненные в позициях документа, к справочнику цен (`Price`).
*   **COMPLETED -> DRAFT / CANCELLED**: Отменяет проведение.
    *   **Валидация**: Проверяет, достаточно ли текущего остатка для списания ("отката") закупки. Если товар уже был продан и остаток меньше, чем в закупке — выбрасывает ошибку.
    *   **Действие**: Уменьшает остаток на складе.
*   **Особенность**: Нельзя изменить статус, если документ уже `CANCELLED`.

## Особенности
*   **Изоляция**: Используется уровень `Serializable`, чтобы гарантировать, что параллельные закупки одного и того же товара правильно пересчитают WAP.
*   **Интеграция**: Плотно взаимодействует с `InventoryService` для валидации и логирования аудита.
