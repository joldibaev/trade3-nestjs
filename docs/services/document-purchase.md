# DocumentPurchaseService (Закупки)

Этот сервис отвечает за создание и управление документами закупки товаров у поставщиков.

## Методы

### `create(dto: CreateDocumentPurchaseDto)`
Основной метод создания закупки. Выполняет следующие шаги в строгом порядке:

1.  **Валидация**:
    *   Проверяет существование склада (`storeId`) через `InventoryService`.
    *   Проверяет существование всех указанных товаров (`productId`).
2.  **Подготовка данных**:
    *   Конвертирует количество и цены в формат `Decimal`.
    *   Рассчитывает сумму по каждой позиции и общий итог документа.
3.  **Транзакция** (`Serializable`):
    *   Создает запись `DocumentPurchase` и связанные `DocumentPurchaseItem`.
    *   Если статус `COMPLETED`:
        *   Получает текущие остатки и текущую себестоимость (WAP) для каждого товара.
        *   **Расчет WAP**: Использует формулу `(Текущая_Стоимость + Новая_Стоимость) / Общее_Кол-во`.
        *   Выполняет `upsert` в таблицу `Stock`, обновляя количество и новую WAP.
        *   **Обновление цен**: Если в DTO переданы `newPrices`, обновляет/создает розничные или оптовые цены товара.
        *   **Аудит**: Через `InventoryService.logStockMovement` создает запись о движении товара типа `PURCHASE`, сохраняя снимки остатка и себестоимости.

### `findAll(include?)`
Возвращает список всех закупок.
*   **Сортировка**: От новых к старым (`createdAt: 'desc'`).
*   **Параметры**: Позволяет через `include` подгрузить связанные данные (склад, поставщик, позиции).

### `findOne(id, include?)`
Возвращает детальную информацию об одной закупке по её ID.
*   Использует `findUniqueOrThrow`. Если закупка не найдена, выбрасывает `404 Not Found`.

## Особенности
*   **Изоляция**: Используется уровень `Serializable`, чтобы гарантировать, что параллельные закупки одного и того же товара правильно пересчитают WAP.
*   **Интеграция**: Плотно взаимодействует с `InventoryService` для валидации и логирования аудита.
