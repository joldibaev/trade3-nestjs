# DocumentPurchaseService (Закупки)

Этот сервис отвечает за создание и управление документами закупки товаров у поставщиков.

## Методы

### `create(dto: CreateDocumentPurchaseDto)`
Основной метод создания закупки. Выполняет следующие шаги в строгом порядке:

1.  **Валидация**:
    *   Проверяет существование склада (`storeId`) через `InventoryService`.
2.  **Транзакция** (`Serializable`):
    *   Создает запись `DocumentPurchase` с суммой 0.
    *   **Позиции**: Позиции товаров (items) **не создаются** на этом этапе, даже если переданы в DTO (они игнорируются или DTO их не содержит).
    *   **Статус документа**: Создается в статусе `DRAFT`.
    *   **Склад**: Остатки и WAP **не изменяются**.

### `update(id: string, dto: UpdateDocumentPurchaseDto)`
Позволяет добавить или обновить позиции товаров и метаданные.

*   **Ограничение**: Доступно только для документов в статусе **DRAFT**.
*   **Логика**:
    *   Удаляет все существующие `items`.
    *   Создает новые `items` из DTO.
    *   Обновляет метаданные документа (дата, поставщик и т.д.).
    *   Автоматически пересчитывает `totalAmount`.

### `remove(id: string)`
Удаляет документ.
*   **Ограничение**: Доступно только для документов в статусе **DRAFT**.
*   **Действие**: Удаляет сам документ и все связанные с ним позиции.

### `findAll(include?)`
Возвращает список всех закупок.
*   **Сортировка**: От новых к старым (`createdAt: 'desc'`).
*   **Параметры**: Позволяет через `include` подгрузить связанные данные (склад, поставщик, позиции).

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Позволяет изменять статус документа.
*   **DRAFT -> COMPLETED**:
    *   Проводит документ. Зачисляет товар на склад, пересчитывает WAP.
    *   Применяет отложенные обновления цен (`newPrices`), сохраненные в позициях документа, к справочнику цен (`Price`).
*   **COMPLETED -> DRAFT / CANCELLED**: Отменяет проведение.
    *   **Валидация**: Проверяет, достаточен ли текущий остаток для списания ("отката") закупки.
    *   **Действие**: Уменьшает остаток на складе.
    *   **Sequence Reprocessing**: Поскольку отмена закупки влияет на WAP (себестоимость) товара, система автоматически запускает **пересчет всех последующих движений** (продаж, списаний) по этому товару, начиная с даты отменяемой закупки. Это корректирует `costPrice` в проданных товарах.
*   **Особенность**: Нельзя изменить статус, если документ уже `CANCELLED`.

## Особенности
*   **Изоляция**: Используется уровень `Serializable`, чтобы гарантировать, что параллельные закупки одного и того же товара правильно пересчитают WAP.
*   **Интеграция**: Плотно взаимодействует с `InventoryService` для валидации и логирования аудита.

## Подробный жизненный цикл (Step-by-Step)

Ниже описано, что конкретно происходит в системе на каждом этапе работы с документом.

### 1. Создание черновика (DRAFT)
Пользователь начинает работу с новой накладной.
*   **Действие**: `POST /document-purchases`
*   **DB**: Создается запись в таблице `DocumentPurchase` со статусом `DRAFT`.
*   **Склад**: Остатки **не меняются**.
*   **Аудит**: Записей в `StockMovement` **нет**.
*   **Смысл**: Оператор может спокойно набивать накладную час или два, не влияя на работу магазина.

### 2. Заполнение товарами
Оператор добавляет товары в накладную.
*   **Действие**: `PATCH /document-purchases/:id` (с массивом `items`)
*   **DB**:
    1.  Старые позиции этого черновика удаляются.
    2.  Новые позиции записываются в `DocumentPurchaseItem`.
*   **Склад**: Остатки всё ещё **не меняются**.

### 3. Проведение (DRAFT -> COMPLETED)
Оператор нажимает кнопку "Провести". Это самый важный момент.
*   **Действие**: `PATCH /document-purchases/:id/status` `{ status: 'COMPLETED' }`
*   **Транзакция (Serializable)**: Включается строгая изоляция, чтобы никто не изменил остаток параллельно.

#### Шаг 3.1: Чтение текущего состояния
Для каждого товара в накладной система читает таблицу `Stock`.
*   *Пример*: Было 10 шт. по цене $100 (WAP).

#### Шаг 3.2: Расчет WAP (Себестоимости)
Система математически смешивает старый товар с новым.
*   *Приходит*: 5 шт. по цене $130.
*   *Формула*: `((10 * $100) + (5 * $130)) / (10 + 5) = $111.66`
*   **Новый WAP**: $111.66

#### Шаг 3.3: Обновление склада
*   **DB**: Выполняется `UPSERT` в таблицу `Stock`.
*   *Результат*: Количество становится 15, `averagePurchasePrice` становится $111.66.

#### Шаг 3.4: Запись Аудита
*   **DB**: Создается запись в `StockMovement` (тип `PURCHASE`).
*   *Важно*: В эту запись сохраняется **снимок** состояния ПОСЛЕ операции (Qty: 15, Price: $111.66). Это "несгораемая" история.

#### Шаг 3.5: Применение новых цен (опционально)
Если оператор указал, что этот приход меняет розничную цену.
*   **DB**: Обновляется таблица `Price` (текущая цена на кассе).
*   **DB**: Создается запись в `PriceHistory`.

#### Шаг 3.6: Финализация
*   **DB**: Статус документа меняется на `COMPLETED`.
*   **Транзакция завершается**.
*   *Итог*: Товар появился на остатках, себестоимость усреднилась, товар доступен для продажи.

### 4. Отмена / Откат (COMPLETED -> DRAFT)
Оператор ошибся и хочет исправить уже проведенную накладную. Или делает полный возврат поставщику (через отмену).
*   **Действие**: `PATCH /document-purchases/:id/status` `{ status: 'DRAFT' }`
*   **Транзакция (Serializable)**: Строгая изоляция.

#### Шаг 4.1: Валидация Остатков
Система проверяет, лежит ли этот товар всё ещё на складе.
*   *Проблема*: Если мы купили 10 шт, а 5 уже продали, у нас на остатке 5. Мы не можем "вернуть в никуда" 10 шт.
*   *Проверка*: `CurrentQty >= PurchaseQty`. Если нет — **Ошибка**. Откат невозможен (сначала отмените продажи).

#### Шаг 4.2: Финансовая Валидация (защита WAP)
Система проверяет, не приведет ли списание к отрицательной стоимости склада.

#### Шаг 4.3: Списание (Revert)
*   **DB**: Уменьшает количество в `Stock` на объем закупки.
*   *Пример*: Было 15 шт. Стало 15 - 5 = 10 шт.

#### Шаг 4.4: Запись Аудита
*   **DB**: Создается запись в `StockMovement` (тип `PURCHASE`, кол-во **-5**).
*   В этот момент `InventoryService` видит "отрицательную закупку".

#### Шаг 4.5: Sequence Reprocessing (Пересчет истории)
Самый сложный этап. Система понимает, что мы изменили прошлое.
1.  **Сбор**: Находит все продажи и движения, которые произошли **после** даты этой закупки.
2.  **Пересчет**: Заново пробегает по цепочке изменений.
    *   Когда натыкается на эту "отмененную" закупку, она **удаляет её влияние** на среднюю цену (WAP).
3.  **Обновление продаж**: Если после этой закупки были продажи, их себестоимость (`costPrice`) автоматически пересчитывается и обновляется в БД.
    *   *Было*: Продали с себестоимостью $111.
    *   *Стало*: Так как дешевую закупку отменили, себестоимость продажи выросла до $130 (обновили запись).

#### Шаг 4.6: Финализация
*   **DB**: Статус документа становится `DRAFT`.
*   Теперь документ снова можно редактировать (менять товары, цены) и провести заново.

