# DocumentTransferService (Перемещения)

Этот сервис управляет процессом перемещения товарно-материальных ценностей (ТМЦ) между складами компании.

## Методы

### `create(dto: CreateDocumentTransferDto)`

Создает черновик перемещения.

- **Валидация**: Проверяет, что `sourceStoreId` (Откуда) и `destinationStoreId` (Куда) существуют и **не совпадают**.
- **Status**: По умолчанию `DRAFT`.
- **Code**: Генерируется автоматически (`T-XXXX`).

### `addItems(id: string, dto: CreateDocumentTransferItemsDto)`

Добавляет товары к перемещению.

- **Ограничение**: Только `DRAFT`.
- **Payload**: `{ items: [{ productId, quantity }] }`.
- **Логика**: Просто фиксирует намерение переместить заданное количество. Проверка наличия остатка на источнике в этот момент **не производится** (она делается при проведении).

### `updateItem(id: string, itemId: string, dto: CreateDocumentTransferItemDto)`

Изменяет количество товара в заявке на перемещение.

### `removeItems(id: string, dto: RemoveDocumentTransferItemsDto)`

Удаляет товары из заявки.

### `updateStatus(id: string, newStatus: DocumentStatus)`

Ключевой метод, выполняющий физическое движение товара.

#### Сценарий: Проведение (DRAFT -> COMPLETED)

1.  **Проверка остатков**: Проверяет, достаточно ли товара на складе-источнике (`Source`). Если хоть одного товара не хватает, выбрасывается ошибка `BadRequestException`, и перемещение не проводится.
2.  **Списание (Source)**: Уменьшает остаток на складе-отправителе.
3.  **Приход (Destination)**: Увеличивает остаток на складе-получателе.
4.  **Расчет WAP (Destination)**:
    - Цена прихода на склад-получатель равна WAP товара на складе-отправителе в момент перемещения.
    - WAP на складе-получателе пересчитывается по формуле взвешенной средней (как при обычной закупке).
5.  **Аудит**: Создает две записи в `StockLedger`:
    - `TRANSFER_OUT` для источника (отрицательное кол-во).
    - `TRANSFER_IN` для получателя (положительное кол-во).
6.  **Reprocessing**: Если документ "задним числом", запускает пересчет истории **на обоих складах**.

#### Сценарий: Отмена (COMPLETED -> DRAFT / CANCELLED)

1.  **Валидация отмены**: Проверяет, достаточно ли товара на складе-получателе, чтобы вернуть его обратно. Если товар уже продан с получателя, отмена запрещена (ошибка).
2.  **Возврат (Reverse Flow)**:
    - Списывает товар со склада-получателя.
    - Возвращает товар на склад-источник.
3.  **Reprocessing**: Всегда запускает пересчет истории для обоих складов.

## Особенности

- **Dual-Store Integrity**: Перемещение — единственная операция, связывающая состояние двух складов синхронно. Используется строгая транзакционность.
- **WAP Transfer**: Стоимость товара "путешествует" вместе с ним. Если на складе А товар стоил 100р, он придет на склад Б с себестоимостью 100р, усредняясь с текущими остатками склада Б.
