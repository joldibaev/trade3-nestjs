# DocumentTransferService (Перемещения)

Сервис для перемещения товаров между внутренними складами организации.

## Методы

### `create(dto: CreateDocumentTransferDto)`
Создает документ перемещения.
*   **Items**: Опциональны.
*   **Status**: По умолчанию `DRAFT`.
*   **Code**: Генерируется автоматически с префиксом `T-` (например, `T-1`).

1.  **Валидация**: Проверяет оба склада.
2.  **Транзакция** (`Serializable`):
    *   Создает `DocumentTransfer`.
    *   Если `COMPLETED`, выполняет перемещение товара (OUT -> IN) с пересчетом WAP получателя.

### `update(id: string, dto: CreateDocumentTransferDto)`
Обновление документа (замена позиций).
*   **Ограничение**: Статус **DRAFT**.
*   **Логика**: Замена всех позиций.

### `remove(id: string)`
Удаление документа.
*   **Ограничение**: Статус **DRAFT**.

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Управление статусом.
*   **DRAFT -> COMPLETED**: Проводит перемещение (списывает с источника, приходует получателю). Запускает пересчет истории в ОБОИХ складах, если дата документа в прошлом.
*   **COMPLETED -> DRAFT / CANCELLED**: Отменяет перемещение. Всегда запускает пересчет истории в обоих складах.
    *   **Откат**: Возвращает товар на источник, списывает с получателя.
    *   **Проверка**: Проверяет, что на складе-получателе достаточно товара для отмены.

## Особенности
*   **Сохранение стоимости**: Перемещения не должны приводить к "исчезновению" или "возникновению" стоимости из ниоткуда. Сумма `Кол-во * WAP` должна сохраняться в рамках системы.
*   **Атомарность**: Если на складе-источнике не хватает хотя бы одного товара из списка, все перемещение (включая приходы на склад-получатель) отменяется.
*   **Dual-Store Reprocessing**: Перемещение — единственная операция, которая может инициировать пересчет сразу в двух разных точках хранения. Система `InventoryReprocessing` корректно обрабатывает такие случаи, гарантируя целостность WAP и остатков по всей сети.
