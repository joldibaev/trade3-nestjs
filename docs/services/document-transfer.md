# DocumentTransferService (Перемещения)

Сервис для перемещения товаров между внутренними складами организации.

## Методы

### `create(dto: CreateDocumentTransferDto)`
Самая сложная логика, так как затрагивает два склада одновременно в одной транзакции.

1.  **Валидация**:
    *   Проверяет оба склада (источник и получатель) на существование.
2.  **Транзакция** (`Serializable`):
    *   Создает `DocumentTransfer`.
    *   **Склад-источник (OUT)**:
        *   Проверяет остатки.
        *   Уменьшает количество.
        *   Считывает `sourceWap`. Перемещение всегда идет по текущей себестоимости склада-отправителя.
    *   **Склад-получатель (IN)**:
        *   Считывает текущие данные (`destQty`, `destWap`).
        *   **Пересчет WAP**: Выполняет расчет новой средневзвешенной цены на складе-получателе, так как к нему "пришел" товар по цене `sourceWap`.
        *   Обновляет `Stock` получателя.
    *   **Аудит**: Логирует **две** записи в `StockMovement`:
        1. тип `TRANSFER_OUT` для склада-отправителя.
        2. тип `TRANSFER_IN` для склада-получателя.

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Проводит перемещение. Выполняет все шаги по списанию и оприходованию в одной атомарной транзакции.
*   **Текущее ограничение**: Пока поддерживается только переход `DRAFT -> COMPLETED`. Логика отмены (`CANCELLED`) еще не реализована из-за сложности двойных проверок остатков.

## Особенности
*   **Сохранение стоимости**: Перемещения не должны приводить к "исчезновению" или "возникновению" стоимости из ниоткуда. Сумма `Кол-во * WAP` должна сохраняться в рамках системы.
*   **Атомарность**: Если на складе-источнике не хватает хотя бы одного товара из списка, все перемещение (включая приходы на склад-получатель) отменяется.
