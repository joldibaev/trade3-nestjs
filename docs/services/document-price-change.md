# DocumentPriceChangeService (Изменение цен)

Сервис для управления документами изменения цен (`DocumentPriceChange`). Позволяет устанавливать новые розничные/оптовые цены, сохраняя историю изменений в `PriceLedger`.

## Описание процесса

В отличие от старого подхода, где цены менялись внутри закупки, теперь процесс разделен:
1.  **Закупка (`DocumentPurchase`)** фиксирует себестоимость.
2.  **Изменение цен (`DocumentPriceChange`)** фиксирует цены продажи.

## Методы

### `create(dto: CreateDocumentPriceChangeDto)`

Создает новый документ изменения цен.

- **Status**: По умолчанию `DRAFT`.
- **Items**: Список товаров с указанием:
    - `priceTypeId` (Тип цены)
    - `newValue` (Новая цена)
    - `oldValue` (Старая цена авто-подставляется из текущей `Price` для истории)

Если документ создается автоматически из закупки, поле `documentPurchaseId` будет содержать ссылку на родительскую закупку.

### `update(id: string, dto: UpdateDocumentPriceChangeDto)`

Обновляет черновик документа.

- **Ограничение**: Только статус `DRAFT`.
- **Логика**: Полная перезапись позиций (удаление старых, создание новых) и обновление метаданных.

### `updateStatus(id: string, status: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`

Меняет статус и применяет изменения.

1.  **DRAFT -> COMPLETED**:
    - Применяет новые цены: обновляет таблицу `Price`.
    - Создает записи в истории `PriceLedger`.
2.  **COMPLETED -> DRAFT / CANCELLED**:
    - **Откат**: Возвращает цены к состоянию, которое было бы без этого документа.
    - Удаляет записи из `PriceLedger`.
    - Пересчитывает текущую цену (`Price`) на основе последней актуальной записи в истории.

### `remove(id: string)`

Удаляет документ.

- **Ограничение**: Только статус `DRAFT`.

## Связь с закупкой

При создании `DocumentPurchase`, если указаны `newPrices`:
- `DocumentPurchaseService` вызывает `DocumentPriceChangeService.create`.
- Создается **отдельный** документ изменения цен.
- Пользователь должен зайти в этот созданный документ и провести его (`COMPLETED`), чтобы цены вступили в силу.
