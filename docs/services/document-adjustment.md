# DocumentAdjustmentService (Инвентаризация)

Сервис для корректировки остатков по результатам инвентаризации (списание недостачи, оприходование излишков).

## Принцип работы: "Delta" (Разница)

В отличие от некоторых систем, где инвентаризация задает "Фактическое количество" (например, "Стало 5"), `DocumentAdjustment` работает с **разницей** (Delta):
- `+5`: нашли излишек.
- `-3`: выявили недостачу.

Это позволяет безопасно применять инвентаризацию даже если во время подсчета шли продажи (при условии правильной организации процесса).

## Методы

### `create` / `update`

Стандартное управление заголовком документа.

### `addItems(id: string, dto: CreateDocumentAdjustmentItemDto)`

- **Payload**: `{ productId, quantity }`
- **Snapshot**: В момент добавления сервисом фиксируется текущий остаток (`quantityBefore`) для справки.
- **Calculation**: Рассчитывается прогнозный `quantityAfter`.

### `updateStatus(id: string, newStatus: DocumentStatus)`

#### Проведение (COMPLETED)
1.  **Refresh Snapshot**: Перед самым проведением сервис обновляет поля `quantityBefore` в позициях, так как с момента создания черновика остатки могли измениться.
2.  **Применение**:
    - Если `quantity > 0`: Работает как приход (Повышает сток).
    - Если `quantity < 0`: Работает как списание (Понижает сток).
3.  **Аудит**: Запись в `StockLedger` с типом `ADJUSTMENT`.
4.  **Reprocessing**: Запуск пересчета истории при необходимости.

#### Отмена (Revert)
1.  **Инверсия**:
    - Было `+5` (приход) -> Станет `-5` (списание).
    - Было `-3` (списание) -> Станет `+3` (возврат).
2.  **Проверка**: Если отменяем "приход", проверяем, что товар есть в наличии.

## Особенности

- **WAP**: При оприходовании излишков (`+`), они обычно приходуются по текущей себестоимости или 0 (в зависимости от настроек `fallbackWap`), чтобы не ломать учет. При списании (`-`), товар уходит по своей текущей себестоимости.
