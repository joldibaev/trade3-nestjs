# DocumentAdjustmentService (Корректировки/Инвентаризация)

Сервис для ручного изменения остатков товаров.

## Методы

### `create(dto: CreateDocumentAdjustmentDto)`
Позволяет прибавить (излишки) или вычесть (недостачи) товар.

1.  **Подготовка**:
    *   Предварительно загружает "запасные" цены закупки (Fallback WAP) через `InventoryService`.
2.  **Транзакция** (`Serializable`):
    *   Считывает текущее количество товара (`quantityBefore`).
    *   Рассчитывает новое количество (`quantityAfter`).
    *   Создает `DocumentAdjustment` и фиксирует снимки количества в `DocumentAdjustmentItem` (поля `quantityBefore/After`).
    *   **Обновление Stock**:
        *   Если это оприходование излишков на "пустой" склад, устанавливает себестоимость из Fallback WAP.
        *   В остальных случаях просто обновляет количество.
    *   **Аудит**: Логирует движение `ADJUSTMENT`.

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Проводит документ инвентаризации.
*   **Текущее ограничение**: Пока поддерживается только переход `DRAFT -> COMPLETED`.
*   **Важно**: Снимки `quantityBefore` и `quantityAfter` фиксируются именно в момент проведения, а не в момент создания черновика. Это гарантирует актуальность данных в акте.

## Особенности
*   **Гибкость**: Количество в позициях может быть как положительным (приход), так и отрицательным (списание).
*   **Snapshot**: Этот сервис единственный, кто хранит `quantityBefore` прямо в позициях документа для удобства сверки актов инвентаризации.
