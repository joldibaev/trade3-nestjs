# DocumentReturnService (Возвраты)

Сервис для оформления возвратов товаров от клиентов.

## Методы

### `create(dto: CreateDocumentReturnDto)`
Оформляет возврат. Шаги:

1.  **Поиск себестоимости (Fallback WAP)**:
    *   Так как возврат может произойти на склад, где товара сейчас нет (остаток 0, цена закупки 0), сервис вызывает `InventoryService.getFallbackWapMap`.
    *   Если на текущем складе цена закупки неизвестна, система ищет её на других складах, чтобы оприходовать возврат по корректной стоимости.
2.  **Транзакция**:
    *   Создает `DocumentReturn`.
    *   **Оприходование**: Выполняет `upsert` в `Stock`. Если товара не было — создает запись с `quantity = возвращенное кол-во` и найденной `fallbackWap`. Если был — просто инкрементирует количество (`increment`).
    *   **Аудит**: Логирует движение `RETURN`.

### `update(id: string, dto: CreateDocumentReturnDto)`
Полное редактирование документа возврата.
*   **Ограничение**: Статус **DRAFT**.
*   **Логика**: Пересоздание позиций. Пересчет Fallback WAP для новых позиций.

### `remove(id: string)`
Удаление возврата.
*   **Ограничение**: Статус **DRAFT**.

### `findAll / findOne`
Стандартные методы получения списка и одного документа.

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Управление статусом возврата.
*   **DRAFT -> COMPLETED**: Оприходует возвращенный товар на склад.
*   **COMPLETED -> DRAFT / CANCELLED**: Отменяет возврат товара.
    *   **Валидация**: Перед отменой (списанием возвращенного товара обратно) проверяет, **достаточно ли этого товара на складе**.
    *   **Причина**: Если вы приняли товар от клиента, а потом успели его снова продать, отменить возврат нельзя.
    *   **Исключение**: `BadRequestException`, если остаток меньше чем количество в возврате.

## Особенности
*   **WAP Policy**: Возврат **не должен** пересчитывать средневзвешенную цену. Он либо использует существующую цену на складе, либо (если склад пуст) использует историческую цену с другого склада.
