# DocumentReturnService (Возвраты)

Сервис для оформления возврата товаров от клиентов (например, при браке или отказе).

## Методы

### `create(dto: CreateDocumentReturnDto)`

Создает черновик возврата.

- **Status**: По умолчанию `DRAFT`.
- **Привязка**: Обязательно указывается клиент `clientId`.

### `addItems(id: string, dto: CreateDocumentReturnItemsDto)`

Добавляет возвращаемые товары.

- **Цена?**: В текущей реализации возврат товара не требует указания цены. Товар возвращается на количественный учет.
- **Логика**: Просто фиксирует список товаров и количество.

### `updateStatus(id: string, newStatus: DocumentStatus)`

#### Сценарий: Проведение (DRAFT -> COMPLETED)

1.  **Приход товара**: Увеличивает остаток товара на складе (`Stock`).
2.  **Влияние на WAP**: Возврат обрабатывается как поступление товара по цене, указанной в позиции возврата. Это позволяет корректно восстанавливать себестоимость даже при возврате товара на склад с нулевым или отсутствующим остатком.
3.  **Reprocessing**: Если возврат оформлен "задним числом", запускается пересчет истории.

#### Сценарий: Отмена (COMPLETED -> DRAFT / CANCELLED)

1.  **Проверка стока**: Проверяет, можно ли изъять возвращенный товар обратно (не был ли он уже перепродан).
2.  **Списание**: Уменьшает остаток на складе.
3.  **Аудит**: Логирует отмену движения.

## Особенности

- **Клиентский контекст**: Возврат всегда привязан к клиенту, что позволяет анализировать "проблемных" покупателей.
- **Safety**: Система защищает склад от "отмены возврата", если этот товар уже физически ушел со склада.
