# DocumentReturnService (Возвраты)

Сервис для оформления возвратов товаров от клиентов.

## Методы

### `create(dto: CreateDocumentReturnDto)`

Создает заголовок возврата.

- **Items**: Добавляются отдельно через `addItems`.
- **Status**: По умолчанию `DRAFT`.
- **Total**: Инициализируется как 0.

### `update(id: string, dto: CreateDocumentReturnDto)`

- **Логика**: Пересоздание позиций.

### `findAll / findOne`

Стандартные методы получения списка и одного документа.

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`

Управление статусом возврата.

- **DRAFT -> COMPLETED**: Оприходует возвращенный товар на склад. Запуск пересчета истории, если дата документа в прошлом.
- **COMPLETED -> DRAFT / CANCELLED**: Отменяет возврат товара. Всегда запускает пересчет истории.
  - **Валидация**: Перед отменой (списанием возвращенного товара обратно) проверяет, **достаточно ли этого товара на складе**.
  - **Причина**: Если вы приняли товар от клиента, а потом успели его снова продать, отменить возврат нельзя.
  - **Исключение**: `BadRequestException`, если остаток меньше чем количество в возврате.

## Особенности

- **WAP Policy**: Возврат **не должен** пересчитывать средневзвешенную цену. Он либо использует существующую цену на складе, либо (если склад пуст) использует историческую цену с другого склада.
- **Reprocessing**: Как и другие документы, возвраты интегрированы в систему `InventoryReprocessing`. Это гарантирует, что если вы вернули товар "вчера", все сегодняшние продажи и перемещения увидят корректный остаток.
