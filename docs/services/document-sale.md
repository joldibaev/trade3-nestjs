# DocumentSaleService (Продажи)

Этот сервис отвечает за создание и управление документами реализации товаров (продажи) клиентам.

## Методы

### `create(dto: CreateDocumentSaleDto)`

Создает заголовок документа продажи.

- **Status**: По умолчанию `DRAFT`.
- **Code**: Генерируется автоматически с префиксом `S-`.
- **Items**: В этом методе **не передаются**. Товары добавляются после создания документа через `addItems`.

1.  **Валидация**: Проверяет существование склада (`storeId`).
2.  **Запись**: Создает `DocumentSale` с суммой 0.
3.  **Логирование**: Записывает действие `CREATED` в `DocumentHistory`.

### `update(id: string, dto: CreateDocumentSaleDto)`

Обновляет заголовочные данные документа (склад, касса, клиент, тип цены, дата, примечания).

- **Ограничение**: Доступно только в статусе `DRAFT`.
- **Логика**: При изменении данных записывает `UPDATED` в `DocumentHistory` с деталями изменений.
- **Позиции**: Позиции товаров в этом методе **не обновляются**.

### `addItems(id: string, dto: CreateDocumentSaleItemsDto)`

Добавляет новые товары в документ.

- **Ограничение**: Доступно только в статусе `DRAFT`.
- **Payload**: `{ items: CreateDocumentSaleItemDto[] }`

1.  **Поиск товаров**: Для каждого товара загружает данные, включая цены.
2.  **Определение цены**:
    - Если цена (`price`) передана явно, используется она.
    - Если нет — ищется цена в справочнике `Price` по `priceTypeId` документа.
    - Если цена не найдена, берется `0`.
3.  **Фиксация себестоимости**: Считывает текущий `averagePurchasePrice` (WAP) из остатков (`Stock`) и сохраняет его в поле `costPrice` позиции. Это необходимо для точного расчета маржи в будущем.
4.  **Расчет**: Вычисляет `total` позиции (`quantity * price`).
5.  **Создание**: Добавляет запись в `DocumentSaleItem`.
6.  **Итог**: Обновляет общую сумму документа (`total`).
7.  **Логирование**: Записывает `ITEM_ADDED` в `DocumentHistory`.

### `updateItem(id: string, itemId: string, dto: UpdateDocumentSaleItemDto)`

Обновляет существующую позицию в документе.

- **Ограничение**: Доступно только в статусе `DRAFT`.

1.  **Пересчет**: Вычисляет новую сумму позиции на основе новых `quantity` или `price`.
2.  **Итог**: Обновляет общую сумму документа (`total`).
3.  **Логирование**: Записывает `ITEM_CHANGED` с деталями "Было/Стало" в `DocumentHistory`.

### `removeItems(id: string, dto: RemoveDocumentSaleItemsDto)`

Удаляет позиции из документа.

- **Ограничение**: Доступно только в статусе `DRAFT`.
- **Payload**: `{ itemIds: string[] }` (Обратите внимание: принимает ID позиций, а не товаров).

1.  **Удаление**: Удаляет записи из `DocumentSaleItem`.
2.  **Итог**: Уменьшает общую сумму документа (`total`).
3.  **Логирование**: Записывает `ITEM_REMOVED` в `DocumentHistory`.

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`

Управляет жизненным циклом документа и движением товаров.

#### Сценарий: Проведение (DRAFT -> COMPLETED)
1.  **Блокировка (Locks)**: Блокирует записи `Stock` для всех товаров в документе, чтобы избежать гонки данных (`ReadCommitted` недостаточно для проверки остатков без `SELECT FOR UPDATE` или Advisory Locks).
2.  **Обновление Cost Price**: Перед самым списанием сервис обновляет `costPrice` во всех позициях до актуального значения WAP (на случай, если с момента добавления товара в корзину прошла закупка).
3.  **Списание**: Вызывает `stock.decrease`, уменьшая остаток на складе.
4.  **Проверка**: Если остаток уходит в минус, транзакция откатывается с ошибкой (если настройки не разрешают отрицательные остатки).
5.  **Аудит**: Записывает `SALE` в `StockLedger`.
6.  **Reprocessing**: Если дата документа в прошлом, запускает пересчет истории.

#### Сценарий: Отмена (COMPLETED -> DRAFT / CANCELLED)
1.  **Возврат товара**: Возвращает списанный товар на склад (Увеличивает остаток).
2.  **Reprocessing**: **Всегда** запускает пересчет истории (`inventoryService.triggerReprocessingIfNeeded`), так как отмена продажи меняет остатки, которые могли быть использованы в будущих движениях.
3.  **Идемпотентность**: Повторная отмена не вызывает ошибок.

### `findAll(include?)`

Возвращает список продаж, отсортированный по дате создания.

## Особенности

- **WAP (Себестоимость)**: Продажа **не изменяет** WAP товара. Она только фиксирует прибыль.
- **Массовость**: `addItems` поддерживает добавление массива товаров за один запрос.
- **Granular Updates**: Система поддерживает атомарное редактирование строк чека, что позволяет быстро работать с большими заказами на POS-терминале без перезаписи всего документа.
