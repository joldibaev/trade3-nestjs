# DocumentSaleService (Продажи)

Этот сервис отвечает за реализацию товара клиентам через кассы.

## Методы

### `create(dto: CreateDocumentSaleDto)`
Создает документ продажи. Основные этапы:

1.  **Валидация склада**: Проверка `storeId` через `InventoryService`.
2.  **Обработка цен**:
    *   Если цена товара не передана явно в DTO, сервис ищет её на основе `priceTypeId`.
    *   Если `priceTypeId` не указан, берется первая доступная цена товара.
3.  **Транзакция** (`ReadCommitted`):
    *   **Проверка остатков**: Перед списанием проверяет, достаточно ли товара на складе (только если статус `COMPLETED`). Если товара не хватает, выбрасывает `BadRequestException`.
    *   **Фиксация себестоимости**: В момент продажи сервис считывает текущую `averagePurchasePrice` из таблицы `Stock` и записывает её в `DocumentSaleItem`. Это необходимо для расчета прибыли.
    *   **Создание документа**: Сохраняет `DocumentSale` и `DocumentSaleItem`.
    *   **Списание (Stock update)**:
        *   Выполняет атомарный `updateMany` с фильтром `quantity: { gte: item.quantity }`. Это дополнительная защита от "ухода в минус" при высокой нагрузке.
    *   **Аудит**: Логирует движение типа `SALE` с отрицательным количеством. Сохраняет снимок остатка после списания.

### `update(id: string, dto: CreateDocumentSaleDto)`
Полное обновление документа (замена позиций).
*   **Ограничение**: Только для статуса **DRAFT**.
*   **Логика**: Старые позиции удаляются, новые создаются. Цены пересчитываются заново.

### `remove(id: string)`
Удаление документа.
*   **Ограничение**: Только для статуса **DRAFT**.

### `findAll(include?)`
Возвращает список продаж с сортировкой по дате создания (новые сверху).

### `updateStatus(id: string, newStatus: 'DRAFT' | 'COMPLETED' | 'CANCELLED')`
Управление статусом продажи.
*   **DRAFT -> COMPLETED**: Проводит продажу. Списывает товар, фиксирует себестоимость (`updateItemCostPrices`) для расчета прибыли.
*   **COMPLETED -> DRAFT / CANCELLED**: Отменяет продажу (например, возврат чека).
    *   **Действие**: Возвращает списанный товар обратно на склад. Увеличивает `quantity` в таблице `Stock`.
    *   **Особенность**: Это безопасная операция, так как возвращает физический товар. Не требует пересчета WAP (так как продажа его не меняла).
    *   **Идемпотентность**: Повторный вызов с тем же статусом не делает ничего.

## Особенности
*   **WAP**: Продажа **никогда не меняет** себестоимость товара в таблице `Stock`. Она только считывает её для фиксации маржинальности конкретной сделки.
*   **Атомарность**: Использование `updateMany` с проверкой условия количества гарантирует, что даже вне Serializable транзакции остаток не станет отрицательным.
