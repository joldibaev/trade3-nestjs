# Глоссарий терминов

В этой документации используются технические термины, касающиеся баз данных и логики складского учета. Ниже приведено их описание.

---

## Складской учет

### WAP (Weighted Average Price)

**Средневзвешенная цена закупки**.
Это метод оценки себестоимости товаров. Вместо того чтобы отслеживать каждую конкретную единицу товара (например, по серийному номеру), система высчитывает среднюю цену.

- **Зачем это нужно?** Когда вы покупаете одну партию товара по $100, а вторую по $120, система вычисляет среднюю цену (например, $110). Эта цена используется как "себестоимость" при продаже для расчета прибыли.

### Sequence Reprocessing (Последовательный пересчет)

**Механизм восстановления истории цен.**
Так как WAP зависит от хронологического порядка операций, любое изменение в прошлом (например, отмена закупки недельной давности) требует пересчета всех последующих документов.

- **Как работает:** Система находит измененный документ, "откатывается" к состоянию на эту дату и заново проигрывает все последующие движения (продажи, перемещения), обновляя в них себестоимость. Это позволяет поддерживать корректную отчетность даже при ошибках операторов задним числом.

### Fallback WAP

**Запасная себестоимость**.
Логика поиска цены, когда на текущем складе её нет.

- **Пример:** Клиент возвращает товар на новый склад, где этот товар никогда не продавался. Система не знает его себестоимость. Она "заглядывает" на другие склады, находит цену там и использует её как подсказку, чтобы не оприходовать товар по нулевой цене.

### Strict Storno (Строгое Сторно)

**Метод исправления ошибок без изменения истории.**
Принцип бухгалтерского учета, при котором ошибочные записи в реестре никогда не редактируются и не удаляются физически.

- **Как исправляется ошибка:** Если операция была проведена неправильно (например, неверная цена в закупке), система создает две новые записи:
  1.  `REVERSAL` (Сторно): Полная копия ошибочной записи, но с противоположным знаком (минус). Она математически "аннигилирует" ошибку.
  2.  `CORRECTION` (Исправление): Новая правильная запись с верными данными.
- **Преимущество:** Полная прозрачность аудита. Можно увидеть не только "как стало", но и "кто ошибся и как исправил".

### Inventory Reprocessing (Инвентаризационный пересчет)

**Системный процесс восстановления согласованности WAP.**
Процесс, запускаемый `Sequence Reprocessing`. Он перебирает исторические движения товара, применяя к ним обновленную себестоимость. Если в ходе пересчета обнаруживается расхождение между записанным и расчетным значением WAP, система генерирует корректирующие записи (`CORRECTION`) в `StockLedger`.

---

## Базы данных и Конкурентность

### ReadCommitted + Advisory Locks

**Текущая стратегия защиты данных в Trade3.**
Комбинация стандартного уровня изоляции `ReadCommitted` и явных рекомендательных блокировок.

- **Зачем:** `Serializable` слишком "дорогой" для базы данных и часто вызывает ошибки ("Serialization Failure") у пользователей при высокой нагрузке.
- **Решение:** Вместо того чтобы полагаться на автоматическую магию БД, система явно "бронирует" (лочит) ID товара перед любой операцией изменения остатков. Это выстраивает параллельные запросы в очередь и гарантирует, что никто не продаст товар, пока другой пересчитывает его цену.

### Optimistic Lock (Оптимистическая блокировка)

Метод защиты от одновременного редактирования старых документов. Реализуется через версионирование (`updatedAt`). Перед сохранением проверяется, не изменил ли кто-то документ, пока вы его редактировали.

### Snapshot (Снимок)

Копия данных в конкретный момент времени.

- В системе аудита (`StockLedger`) мы сохраняем "снимки" остатка и цены после каждой операции. Это позволяет нам не только знать текущий остаток, но и восстановить историю: "Сколько штук и по какой цене было на складе ровно месяц назад?".

### Upsert (Update + Insert)

Операция в БД: "Если запись существует — обнови её, если нет — создай новую". Применяется для управления остатками на складах.
