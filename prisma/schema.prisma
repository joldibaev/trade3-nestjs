// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum DocumentStatus {
  DRAFT
  COMPLETED
  CANCELLED
  SCHEDULED
}

// Store
model Store {
  id                         String                      @id @default(uuid(7))
  name                       String
  address                    String?
  phone                      String?
  workingHours               String?
  isActive                   Boolean                     @default(true)
  cashboxes                  Cashbox[]
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  stocks                     Stock[]
  sales                      DocumentSale[]
  purchases                  DocumentPurchase[]
  returns                    DocumentReturn[]
  adjustments                DocumentAdjustment[]
  transfersFrom              DocumentTransfer[]          @relation("SourceStore")
  transfersTo                DocumentTransfer[]          @relation("DestinationStore")
  stockLedger                StockLedger[]
  inventoryReprocessingItems InventoryReprocessingItem[]

  @@unique([name])
}

model Cashbox {
  id        String         @id @default(uuid(7))
  name      String
  store     Store          @relation(fields: [storeId], references: [id])
  storeId   String
  sales     DocumentSale[]
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@unique([name, storeId])
}

// Price
model PriceType {
  id               String                    @id @default(uuid(7))
  name             String
  priceLedger      PriceLedger[]
  prices           Price[]
  sales            DocumentSale[]
  priceChangeItems DocumentPriceChangeItem[]
  isActive         Boolean                   @default(true)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt

  @@unique([name])
}

model PriceLedger {
  id          String    @id @default(uuid(7))
  valueBefore Decimal   @default(0) @db.Decimal(12, 2)
  value       Decimal   @db.Decimal(12, 2)
  product     Product   @relation(fields: [productId], references: [id])
  productId   String
  priceType   PriceType @relation(fields: [priceTypeId], references: [id])
  priceTypeId String

  // Source Document linking
  documentPriceChange   DocumentPriceChange? @relation(fields: [documentPriceChangeId], references: [id])
  documentPriceChangeId String?

  batchId String?

  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, priceTypeId, date(sort: Desc)])
  @@index([batchId])
}

model Price {
  id          String    @id @default(uuid(7))
  value       Decimal   @db.Decimal(12, 2)
  product     Product   @relation(fields: [productId], references: [id])
  productId   String
  priceType   PriceType @relation(fields: [priceTypeId], references: [id])
  priceTypeId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, priceTypeId])
}

// Product
model Category {
  id        String     @id @default(uuid(7))
  name      String
  products  Product[]
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  parentId  String?
  children  Category[] @relation("CategoryHierarchy")
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([name])
}

model Stock {
  id                   String   @id @default(uuid(7))
  quantity             Decimal  @default(0) @db.Decimal(12, 3)
  averagePurchasePrice Decimal  @default(0) @db.Decimal(12, 2)
  product              Product  @relation(fields: [productId], references: [id])
  productId            String
  store                Store    @relation(fields: [storeId], references: [id])
  storeId              String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([productId, storeId])
}

model Product {
  id                         String                      @id @default(uuid(7))
  code                       String                      @unique
  name                       String
  article                    String?
  category                   Category                    @relation(fields: [categoryId], references: [id])
  categoryId                 String
  prices                     Price[]
  priceLedger                PriceLedger[]
  stocks                     Stock[]
  saleItems                  DocumentSaleItem[]
  purchaseItems              DocumentPurchaseItem[]
  returnItems                DocumentReturnItem[]
  adjustmentItems            DocumentAdjustmentItem[]
  transferItems              DocumentTransferItem[]
  priceChangeItems           DocumentPriceChangeItem[]
  barcodes                   Barcode[]
  stockLedger                StockLedger[]
  inventoryReprocessingItems InventoryReprocessingItem[]
  isActive                   Boolean                     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, name])
}

// Barcode
enum BarcodeType {
  EAN13
  EAN8
  CODE128
  INTERNAL
  OTHER
}

model Barcode {
  id        String      @id @default(uuid(7))
  value     String
  type      BarcodeType @default(EAN13)
  product   Product     @relation(fields: [productId], references: [id])
  productId String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([value])
}

// People
model Vendor {
  id        String             @id @default(uuid(7))
  name      String
  phone     String?
  email     String?
  address   String?
  purchases DocumentPurchase[]
  isActive  Boolean            @default(true)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@unique([name])
}

model Client {
  id        String           @id @default(uuid(7))
  name      String
  phone     String?
  email     String?
  address   String?
  sales     DocumentSale[]
  returns   DocumentReturn[]
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([name])
}

model DocumentSale {
  id                     String                  @id @default(uuid(7))
  code                   String                  @unique
  date                   DateTime                @default(now())
  store                  Store                   @relation(fields: [storeId], references: [id])
  storeId                String
  cashbox                Cashbox?                @relation(fields: [cashboxId], references: [id])
  cashboxId              String?
  client                 Client?                 @relation(fields: [clientId], references: [id])
  clientId               String?
  total                  Decimal                 @default(0) @db.Decimal(12, 2)
  items                  DocumentSaleItem[]
  status                 DocumentStatus          @default(DRAFT)
  priceType              PriceType?              @relation(fields: [priceTypeId], references: [id])
  priceTypeId            String?
  notes                  String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  stockLedger            StockLedger[]
  documentHistory        DocumentHistory[]
  inventoryReprocessings InventoryReprocessing[]
}

model DocumentSaleItem {
  id        String       @id @default(uuid(7))
  sale      DocumentSale @relation(fields: [saleId], references: [id])
  saleId    String
  product   Product      @relation(fields: [productId], references: [id])
  productId String
  quantity  Decimal      @db.Decimal(12, 3)
  price     Decimal      @db.Decimal(12, 2)
  costPrice Decimal      @default(0) @db.Decimal(12, 2)
  total     Decimal      @db.Decimal(12, 2)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model DocumentPurchase {
  id                     String                  @id @default(uuid(7))
  code                   String                  @unique
  date                   DateTime                @default(now())
  vendor                 Vendor?                 @relation(fields: [vendorId], references: [id])
  vendorId               String?
  store                  Store                   @relation(fields: [storeId], references: [id])
  storeId                String
  total                  Decimal                 @default(0) @db.Decimal(12, 2)
  items                  DocumentPurchaseItem[]
  status                 DocumentStatus          @default(DRAFT)
  notes                  String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  stockLedger            StockLedger[]
  documentHistory        DocumentHistory[]
  inventoryReprocessings InventoryReprocessing[]

  // Optional: Link to a price change document generated from this purchase
  generatedPriceChange DocumentPriceChange? @relation("PurchaseToPriceChange")
}

model DocumentPurchaseItem {
  id         String           @id @default(uuid(7))
  purchase   DocumentPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  purchaseId String
  product    Product          @relation(fields: [productId], references: [id])
  productId  String
  quantity   Decimal          @db.Decimal(12, 3)
  price      Decimal          @db.Decimal(12, 2)
  total      Decimal          @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DocumentReturn {
  id                     String                  @id @default(uuid(7))
  code                   String                  @unique
  date                   DateTime                @default(now())
  store                  Store                   @relation(fields: [storeId], references: [id])
  storeId                String
  client                 Client?                 @relation(fields: [clientId], references: [id])
  clientId               String?
  total                  Decimal                 @default(0) @db.Decimal(12, 2)
  items                  DocumentReturnItem[]
  status                 DocumentStatus          @default(DRAFT)
  notes                  String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  stockLedger            StockLedger[]
  documentHistory        DocumentHistory[]
  inventoryReprocessings InventoryReprocessing[]
}

model DocumentReturnItem {
  id        String         @id @default(uuid(7))
  return    DocumentReturn @relation(fields: [returnId], references: [id])
  returnId  String
  product   Product        @relation(fields: [productId], references: [id])
  productId String
  quantity  Decimal        @db.Decimal(12, 3)
  price     Decimal        @db.Decimal(12, 2)
  total     Decimal        @db.Decimal(12, 2)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model DocumentAdjustment {
  id                     String                   @id @default(uuid(7))
  code                   String                   @unique
  date                   DateTime                 @default(now())
  store                  Store                    @relation(fields: [storeId], references: [id])
  storeId                String
  items                  DocumentAdjustmentItem[]
  status                 DocumentStatus           @default(DRAFT)
  notes                  String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  stockLedger            StockLedger[]
  documentHistory        DocumentHistory[]
  inventoryReprocessings InventoryReprocessing[]
}

model DocumentAdjustmentItem {
  id             String             @id @default(uuid(7))
  adjustment     DocumentAdjustment @relation(fields: [adjustmentId], references: [id])
  adjustmentId   String
  product        Product            @relation(fields: [productId], references: [id])
  productId      String
  quantity       Decimal            @db.Decimal(12, 3)
  quantityBefore Decimal            @default(0) @db.Decimal(12, 3)
  quantityAfter  Decimal            @default(0) @db.Decimal(12, 3)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

model DocumentTransfer {
  id                     String                  @id @default(uuid(7))
  code                   String                  @unique
  date                   DateTime                @default(now())
  sourceStore            Store                   @relation("SourceStore", fields: [sourceStoreId], references: [id])
  sourceStoreId          String
  destinationStore       Store                   @relation("DestinationStore", fields: [destinationStoreId], references: [id])
  destinationStoreId     String
  items                  DocumentTransferItem[]
  status                 DocumentStatus          @default(DRAFT)
  notes                  String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  stockLedger            StockLedger[]
  documentHistory        DocumentHistory[]
  inventoryReprocessings InventoryReprocessing[]
}

model DocumentTransferItem {
  id         String           @id @default(uuid(7))
  transfer   DocumentTransfer @relation(fields: [transferId], references: [id])
  transferId String
  product    Product          @relation(fields: [productId], references: [id])
  productId  String
  quantity   Decimal          @db.Decimal(12, 3)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

model DocumentPriceChange {
  id   String   @id @default(uuid(7))
  code String   @unique
  date DateTime @default(now())

  status DocumentStatus @default(DRAFT)
  notes  String?

  items DocumentPriceChangeItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documentHistory      DocumentHistory[]
  generatedPriceLedger PriceLedger[]

  // Relation to the purchase that generated this price change
  documentPurchase   DocumentPurchase? @relation("PurchaseToPriceChange", fields: [documentPurchaseId], references: [id])
  documentPurchaseId String?           @unique
}

model DocumentPriceChangeItem {
  id         String              @id @default(uuid(7))
  document   DocumentPriceChange @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  priceType   PriceType @relation(fields: [priceTypeId], references: [id])
  priceTypeId String

  oldValue Decimal @db.Decimal(12, 2)
  newValue Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Stock Ledger (formerly StockMovement)
enum StockMovementType {
  PURCHASE
  SALE
  RETURN
  ADJUSTMENT
  TRANSFER_IN
  TRANSFER_OUT
}

model StockLedger {
  id        String            @id @default(uuid(7))
  type      StockMovementType
  store     Store             @relation(fields: [storeId], references: [id])
  storeId   String
  product   Product           @relation(fields: [productId], references: [id])
  productId String

  quantityBefore Decimal @default(0) @db.Decimal(12, 3) // Snapshot of stock balance before operation
  quantity       Decimal @db.Decimal(12, 3)
  quantityAfter  Decimal @default(0) @db.Decimal(12, 3) // Snapshot of stock balance after operation

  averagePurchasePrice Decimal @default(0) @db.Decimal(12, 2) // Snapshot of cost price (WAP)
  transactionAmount    Decimal @default(0) @db.Decimal(12, 2) // Total value of the movement (qty * price/cost)

  batchId String? // ID to group movements from a single logic transaction

  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Direct Relations to Source Documents
  documentPurchase   DocumentPurchase? @relation(fields: [documentPurchaseId], references: [id])
  documentPurchaseId String?

  documentSale   DocumentSale? @relation(fields: [documentSaleId], references: [id])
  documentSaleId String?

  documentReturn   DocumentReturn? @relation(fields: [documentReturnId], references: [id])
  documentReturnId String?

  documentAdjustment   DocumentAdjustment? @relation(fields: [documentAdjustmentId], references: [id])
  documentAdjustmentId String?

  documentTransfer   DocumentTransfer? @relation(fields: [documentTransferId], references: [id])
  documentTransferId String?

  @@index([storeId, productId, date(sort: Desc)])
  @@index([productId, date(sort: Desc)])
  @@index([batchId])
  @@index([date])
}

// Inventory Reprocessing Document (System)
model InventoryReprocessing {
  id     String   @id @default(uuid(7))
  date   DateTime @default(now())
  status String // PENDING, COMPLETED, FAILED

  // The document that triggered this reprocessing
  documentPurchase   DocumentPurchase? @relation(fields: [documentPurchaseId], references: [id])
  documentPurchaseId String?

  documentSale   DocumentSale? @relation(fields: [documentSaleId], references: [id])
  documentSaleId String?

  documentReturn   DocumentReturn? @relation(fields: [documentReturnId], references: [id])
  documentReturnId String?

  documentAdjustment   DocumentAdjustment? @relation(fields: [documentAdjustmentId], references: [id])
  documentAdjustmentId String?

  documentTransfer   DocumentTransfer? @relation(fields: [documentTransferId], references: [id])
  documentTransferId String?

  items InventoryReprocessingItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InventoryReprocessingItem {
  id             String                @id @default(uuid(7))
  reprocessing   InventoryReprocessing @relation(fields: [reprocessingId], references: [id], onDelete: Cascade)
  reprocessingId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  store   Store  @relation(fields: [storeId], references: [id])
  storeId String

  oldAveragePurchasePrice Decimal @db.Decimal(12, 2)
  newAveragePurchasePrice Decimal @db.Decimal(12, 2)
  oldQuantity             Decimal @db.Decimal(12, 3)
  newQuantity             Decimal @db.Decimal(12, 3)

  affectedLedgerCount Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// History
model DocumentHistory {
  id      String @id @default(uuid(7))
  action  String // e.g. "CREATED", "UPDATED", "STATUS_CHANGED", "ITEM_ADDED", "ITEM_REMOVED", "ITEM_CHANGED"
  details Json? // Structured data about what changed (oldVal, newVal)

  // Polymorphic-like relations (one of these should be set)
  documentPurchase   DocumentPurchase? @relation(fields: [documentPurchaseId], references: [id])
  documentPurchaseId String?

  documentSale   DocumentSale? @relation(fields: [documentSaleId], references: [id])
  documentSaleId String?

  documentReturn   DocumentReturn? @relation(fields: [documentReturnId], references: [id])
  documentReturnId String?

  documentAdjustment   DocumentAdjustment? @relation(fields: [documentAdjustmentId], references: [id])
  documentAdjustmentId String?

  documentTransfer   DocumentTransfer? @relation(fields: [documentTransferId], references: [id])
  documentTransferId String?

  documentPriceChange   DocumentPriceChange? @relation(fields: [documentPriceChangeId], references: [id])
  documentPriceChangeId String?

  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([documentPurchaseId])
  @@index([documentSaleId])
  @@index([documentReturnId])
  @@index([documentAdjustmentId])
  @@index([documentTransferId])
  @@index([documentPriceChangeId])
}
