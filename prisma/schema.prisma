// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum DocumentStatus {
  DRAFT
  COMPLETED
  CANCELLED
}

model User {
  id        String   @id @default(uuid(7))
  username  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([username])
}

// Store
model Store {
  id            String               @id @default(uuid(7))
  name          String
  cashboxes     Cashbox[]
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  stocks        Stock[]
  sales         DocumentSale[]
  purchases     DocumentPurchase[]
  returns       DocumentReturn[]
  adjustments   DocumentAdjustment[]
  transfersFrom DocumentTransfer[]   @relation("SourceStore")
  transfersTo   DocumentTransfer[]   @relation("DestinationStore")
  movements     StockMovement[]

  @@unique([name])
}

model Cashbox {
  id        String         @id @default(uuid(7))
  name      String
  store     Store          @relation(fields: [storeId], references: [id])
  storeId   String
  sales     DocumentSale[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@unique([name, storeId])
}

// Price
model PriceType {
  id                         String                      @id @default(uuid(7))
  name                       String
  prices                     Price[]
  sales                      DocumentSale[]
  documentPurchaseItemPrices DocumentPurchaseItemPrice[]
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt

  @@unique([name])
}

model Price {
  id          String    @id @default(uuid(7))
  value       Decimal
  product     Product   @relation(fields: [productId], references: [id])
  productId   String
  priceType   PriceType @relation(fields: [priceTypeId], references: [id])
  priceTypeId String

  // Source Document linking
  documentPurchase   DocumentPurchase? @relation(fields: [documentPurchaseId], references: [id])
  documentPurchaseId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, priceTypeId]) // Optimized for finding latest price
}

// Product
model Category {
  id        String     @id @default(uuid(7))
  name      String
  products  Product[]
  parent    Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  parentId  String?
  children  Category[] @relation("CategoryHierarchy")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([name])
}

model Stock {
  id                   String   @id @default(uuid(7))
  quantity             Decimal  @default(0)
  averagePurchasePrice Decimal  @default(0)
  product              Product  @relation(fields: [productId], references: [id])
  productId            String
  store                Store    @relation(fields: [storeId], references: [id])
  storeId              String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([productId, storeId])
}

model Product {
  id              String                   @id @default(uuid(7))
  name            String
  article         String?
  category        Category                 @relation(fields: [categoryId], references: [id])
  categoryId      String
  prices          Price[]
  stocks          Stock[]
  saleItems       DocumentSaleItem[]
  purchaseItems   DocumentPurchaseItem[]
  returnItems     DocumentReturnItem[]
  adjustmentItems DocumentAdjustmentItem[]
  transferItems   DocumentTransferItem[]
  barcodes        Barcode[]
  movements       StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, name])
}

// Barcode
enum BarcodeType {
  EAN13
  EAN8
  CODE128
  INTERNAL
  OTHER
}

model Barcode {
  id        String      @id @default(uuid(7))
  value     String
  type      BarcodeType @default(EAN13)
  product   Product     @relation(fields: [productId], references: [id])
  productId String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([productId, value])
}

// People
model Vendor {
  id        String             @id @default(uuid(7))
  name      String
  phone     String?
  email     String?
  address   String?
  purchases DocumentPurchase[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@unique([name])
}

model Client {
  id        String           @id @default(uuid(7))
  name      String
  phone     String?
  email     String?
  address   String?
  sales     DocumentSale[]
  returns   DocumentReturn[]
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([name])
}

model DocumentSale {
  id          String             @id @default(uuid(7))
  code        Int                @unique @default(autoincrement())
  date        DateTime           @default(now())
  store       Store              @relation(fields: [storeId], references: [id])
  storeId     String
  cashbox     Cashbox?           @relation(fields: [cashboxId], references: [id])
  cashboxId   String?
  client      Client?            @relation(fields: [clientId], references: [id])
  clientId    String?
  totalAmount Decimal
  items       DocumentSaleItem[]
  status      DocumentStatus     @default(DRAFT)
  priceType   PriceType?         @relation(fields: [priceTypeId], references: [id])
  priceTypeId String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  movements   StockMovement[]
}

model DocumentSaleItem {
  id        String       @id @default(uuid(7))
  sale      DocumentSale @relation(fields: [saleId], references: [id])
  saleId    String
  product   Product      @relation(fields: [productId], references: [id])
  productId String
  quantity  Decimal
  price     Decimal
  costPrice Decimal      @default(0)
  total     Decimal
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model DocumentPurchase {
  id              String                 @id @default(uuid(7))
  code            Int                    @unique @default(autoincrement())
  date            DateTime               @default(now())
  vendor          Vendor?                @relation(fields: [vendorId], references: [id])
  vendorId        String?
  store           Store                  @relation(fields: [storeId], references: [id])
  storeId         String
  totalAmount     Decimal
  items           DocumentPurchaseItem[]
  status          DocumentStatus         @default(DRAFT)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  movements       StockMovement[]
  generatedPrices Price[]
}

model DocumentPurchaseItem {
  id         String           @id @default(uuid(7))
  purchase   DocumentPurchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  purchaseId String
  product    Product          @relation(fields: [productId], references: [id])
  productId  String
  quantity   Decimal
  price      Decimal
  total      Decimal

  newPrices DocumentPurchaseItemPrice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DocumentPurchaseItemPrice {
  id     String               @id @default(uuid(7))
  item   DocumentPurchaseItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId String

  priceType   PriceType @relation(fields: [priceTypeId], references: [id])
  priceTypeId String

  value Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DocumentReturn {
  id          String               @id @default(uuid(7))
  code        Int                  @unique @default(autoincrement())
  date        DateTime             @default(now())
  store       Store                @relation(fields: [storeId], references: [id])
  storeId     String
  client      Client?              @relation(fields: [clientId], references: [id])
  clientId    String?
  totalAmount Decimal
  items       DocumentReturnItem[]
  status      DocumentStatus       @default(DRAFT)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  movements   StockMovement[]
}

model DocumentReturnItem {
  id        String         @id @default(uuid(7))
  return    DocumentReturn @relation(fields: [returnId], references: [id])
  returnId  String
  product   Product        @relation(fields: [productId], references: [id])
  productId String
  quantity  Decimal
  price     Decimal
  total     Decimal
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model DocumentAdjustment {
  id        String                   @id @default(uuid(7))
  code      Int                      @unique @default(autoincrement())
  date      DateTime                 @default(now())
  store     Store                    @relation(fields: [storeId], references: [id])
  storeId   String
  items     DocumentAdjustmentItem[]
  status    DocumentStatus           @default(DRAFT)
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt
  movements StockMovement[]
}

model DocumentAdjustmentItem {
  id             String             @id @default(uuid(7))
  adjustment     DocumentAdjustment @relation(fields: [adjustmentId], references: [id])
  adjustmentId   String
  product        Product            @relation(fields: [productId], references: [id])
  productId      String
  quantity       Decimal
  quantityBefore Decimal            @default(0)
  quantityAfter  Decimal            @default(0)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

model DocumentTransfer {
  id                 String                 @id @default(uuid(7))
  code               Int                    @unique @default(autoincrement())
  date               DateTime               @default(now())
  sourceStore        Store                  @relation("SourceStore", fields: [sourceStoreId], references: [id])
  sourceStoreId      String
  destinationStore   Store                  @relation("DestinationStore", fields: [destinationStoreId], references: [id])
  destinationStoreId String
  items              DocumentTransferItem[]
  status             DocumentStatus         @default(DRAFT)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  movements          StockMovement[]
}

model DocumentTransferItem {
  id         String           @id @default(uuid(7))
  transfer   DocumentTransfer @relation(fields: [transferId], references: [id])
  transferId String
  product    Product          @relation(fields: [productId], references: [id])
  productId  String
  quantity   Decimal
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

// Stock Movement Log
enum StockMovementType {
  PURCHASE
  SALE
  RETURN
  ADJUSTMENT
  TRANSFER_IN
  TRANSFER_OUT
}

model StockMovement {
  id        String            @id @default(uuid(7))
  type      StockMovementType
  store     Store             @relation(fields: [storeId], references: [id])
  storeId   String
  product   Product           @relation(fields: [productId], references: [id])
  productId String

  quantity             Decimal
  quantityAfter        Decimal @default(0) // Snapshot of stock balance after operation
  averagePurchasePrice Decimal @default(0) // Snapshot of cost price at moment of operation

  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Direct Relations to Source Documents
  documentPurchase   DocumentPurchase? @relation(fields: [documentPurchaseId], references: [id])
  documentPurchaseId String?

  documentSale   DocumentSale? @relation(fields: [documentSaleId], references: [id])
  documentSaleId String?

  documentReturn   DocumentReturn? @relation(fields: [documentReturnId], references: [id])
  documentReturnId String?

  documentAdjustment   DocumentAdjustment? @relation(fields: [documentAdjustmentId], references: [id])
  documentAdjustmentId String?

  documentTransfer   DocumentTransfer? @relation(fields: [documentTransferId], references: [id])
  documentTransferId String?

  @@index([storeId, productId])
  @@index([date])
}
